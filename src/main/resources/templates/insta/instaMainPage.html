<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <link rel="stylesheet" href="/public/css/common.css">
    <link rel="stylesheet" href="/public/css/basecamp.css">
    <link rel="stylesheet" href="/public/css/insta/instaStyle.css">

    <!-- 이걸로 레이아웃 확인하셈 -->
    <script src="/public/js/lockLikeMobile.js"></script>
    
    <title>campstagram</title>


    <style>
        /* 오프캠버스 css */
        .offcanvas-bottom {
            border-radius: 10px 10px 0 0; /* 위쪽 모서리 둥글게 */
            /* 위쪽 모서리 두 개는 10px로 둥글게 만들고, 아래쪽 모서리 두 개는 둥글게 만들지 않겠다는 의미입니다. */
        }

        .comment-button {
            display: inline-flex;
            align-items: baseline; /* 텍스트의 기본 위치에 맞춰 정렬 */
            line-height: 0; /* 스팬과 동일한 라인 높이 설정 */
        }

        .bottom-nav-fixed {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 1030;
        }
        
        /* 댓글 작성 */
        .qqq {
            margin-left: -16px; /* 원하는 만큼 값을 조정하세요 */
        }

    </style>

</head>
<body>
<div class="container mb-4" style="padding-bottom: 30px;">
    <!-- 상단바 -->
    <div class="row mb-5 pb-2">
        <div class="col">
            <div class="row border-bottom fixed-top px-2" style="background-color: white;">
                <div class="col-4 pe-0">
                    <img src="/public/img/instaImage/campstagram.png" class="img-fluid">
                    <!-- <img src="/public/img/instaImage/instagram.png" class="img-fluid"> -->
                    <!-- <i class="fa-brands fa-square-instagram" style="color: #E1306C;"></i> -->
                </div>
                <div class="col ps-1 search-container">
                    <i class="bi bi-search"></i>         
                    <input id="searchInput" name="searchWord" type="text" class="form-control form-control-sm" placeholder="검색">
                </div>    
            </div>
        </div>
    </div>

    <!-- canvas 시작 -->
    <div class="row g-0 offcanvas offcanvas-end custom-offcanvas-width custom-offcanvas-background" id="offcanvasRight" tabindex="-1" style="width: 17rem;">
        <div class="col">
            <!-- 로그인 & 비로그인 -->
            <div class="row offcanvas-header pt-4 pb-0" style="position: relative;">
                <div class="col-auto pe-1">
                    <div class="row">
                        <div class="col">
                            <a href="/user/login" th:if="${session.sessionUserInfo == null}">
                                <span style="font-size: 1.3em;" class="fw-bold">로그인</span>
                                <span class="material-symbols-outlined" style="font-size: 1.1em;">
                                    arrow_forward_ios
                                </span>
                            </a>
                            <span th:text="${session.sessionUserInfo.nickname}" th:if="${session.sessionUserInfo != null}"
                                style="font-size: 1.3em;" class="fw-bold">닉네임</span>
                            <span th:if="${session.sessionUserInfo != null}"> 님</span>
                        </div>
                    </div>
                </div>
                <!-- 마이페이지 -->
                <a href="/user/myPage" class="col ps-0" th:if="${session.sessionUserInfo != null}">
                    <span class="material-symbols-outlined pt-2" style="font-size: 1.1em;">
                        arrow_forward_ios
                    </span>
                </a>

                <div class="col text-end position-relative ps-0" th:if="${session.sessionUserInfo != null}">
                    <span class="fw-light" style="font-size: 1.2em;">
                        <i class="fa-regular fa-bell"></i>
                    </span><span><i class="bi bi-dot position-absolute king" style="color: rgb(233, 40, 40); font-size: 1.5em;"></i></span>
                </div>
            </div>

            <!-- 이메일 -->
            <div class="row">
                <div class="col-auto" style="padding-left: 10%;">
                    <span th:text="${session.sessionUserInfo.email}" th:if="${session.sessionUserInfo != null}" style="font-size: 0.75em; color: rgb(83, 83, 83);">

                    </span>
                </div>
            </div>

            <!-- 포인트(마일리지) -->
            <div class="row pt-2" th:if="${session.sessionUserInfo != null}">
                <div class="col-auto pe-0" style="font-size: 0.8em; padding-left: 10%;">
                    <span style="color: rgb(168, 168, 168);">포인트</span>
                </div>
                <div class="col-auto ps-1" style="font-size: 0.8em;">
                    <span class="fw-bold lightFont" th:text="${session.sessionUserInfo.mileage}" th:if="${session.sessionUserInfo != null}">
                    </span>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col">
                    <!-- 임시 배너 바꾸셈 -->
                    <img src="/public/img/common/배너저쩌고.jpg" class="img-fluid">
                </div>
            </div>

            <div class="row">
                <div class="col order-list-scroll">
                    <!-- 내용 -->
                    <div class="row offcanvas-body m-0 pt-0">
                        <div class="col" style="font-size: 0.9em;">
                            <!-- 캠핑장 -->
                            <a href="/camp/main" class="row align-end pt-4">
                                <!-- <div class="col-auto pe-0">
                                    <span class="fs-1 material-symbols-outlined">camping</span>
                                </div> -->
                                <div class="col ps-0">
                                    <span>캠핑장</span>
                                </div>
                            </a>
                            <!-- 캠핑카 -->
                            <a href="/campingcar/main" class="row align-end pt-4">
                                <!-- <div class="col-auto pe-0">
                                    <span class="fs-1 material-symbols-outlined">car_repair</span>
                                </div> -->
                                <div class="col ps-0">
                                    <span>캠핑카</span>
                                </div>
                            </a>
                            <!-- 상점 -->
                            <a href="/store" class="row align-end pt-4">
                                <!-- <div class="col-auto pe-0">
                                    <span class="material-symbols-outlined">storefront</span>
                                </div> -->
                                <div class="col ps-0">
                                    <span>상점</span>
                                </div>
                            </a>
                            <!-- 중고거래 -->
                            <a href="/secondhandProduct/mainPage" class="row align-end pt-4">
                                <!-- <div class="col-auto pe-0">
                                    <span class="material-symbols-outlined">settings_accessibility</span>
                                </div> -->
                                <div class="col ps-0">
                                    <span>중고거래</span>
                                </div>
                            </a>
                            <!-- 인스타 -->
                            <!-- <a href="#" class="row align-end pt-4">
                                <div class="col ps-0">
                                    <span>인스타그램</span>
                                </div>
                            </a> -->
                            <!-- 모임 -->
                            <a href="/club/main" class="row align-end pt-4">
                                <!-- <div class="col-auto pe-0">
                                    <span class="material-symbols-outlined">settings_accessibility</span>
                                </div> -->
                                <div class="col ps-0">
                                    <span>소모임</span>
                                </div>
                            </a>                        
                        </div>
                    </div>

                    <!-- 캠프스타그램 -->
                    <div class="row border-top m-0">
                        <a href="/insta/instaMainPage" class="col-5 pt-3 pb-3" style="font-size: 0.9em;">
                            <!-- My -->
                            <!-- <div class="col-auto pe-0">
                                <span class="material-symbols-outlined">settings_accessibility</span>
                            </div> -->
                            <img src="/public/img/instaImage/campstagram.png" class="img-fluid">
                        </a>
                    </div>

                    <!-- 유튜브, 트위터, 페이스북 로고 -->
                    <div class="row border-top m-0 pt-3 pb-3" style="padding-left: 12px;">
                        <div class="col-auto">
                            <div class="row pe-2">
                                <div class="col-auto rounded-circle border border-dark d-flex align-items-center justify-content-center" style="aspect-ratio: 1/1; width: 28px;">
                                    <i class="fa-brands fa-youtube"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="row pe-2">
                                <div class="col-auto rounded-circle border border-dark d-flex align-items-center justify-content-center" style="aspect-ratio: 1/1; width: 28px;">
                                    <i class="fa-brands fa-x-twitter"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="row pe-2">
                                <div class="col-auto rounded-circle border border-dark d-flex align-items-center justify-content-center" style="aspect-ratio: 1/1; width: 28px;">
                                    <i class="fa-brands fa-facebook"></i>
                                </div>
                            </div>
                        </div>

                    </div>

                    <div class="row m-0 pb-3 border-top border-bottom" style="font-size: 0.8em; color: rgb(168, 168, 168);">
                        <div class="col">
                            <div class="row pt-3">
                                <div class="col">
                                    <span>고객센터</span>
                                </div>
                            </div>
                            <div class="row pt-3">
                                <div class="col">
                                    <span>공지사항</span>
                                </div>
                            </div>
                            <div class="row pt-3">
                                <div class="col">
                                    <span>이용약관 / 개인정보 처리방침</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 로그아웃 -->
                    <div class="row pt-4 pb-5 m-0 justify-content-center">
                        <a class="col-auto d-flex align-items-center" th:if="${session.sessionUserInfo != null}" href="/user/logoutProcess">
                            <!-- <button th:if="${session.sessionUserInfo == null}"
                                    type="button" class="btn-close-custom" data-bs-dismiss="offcanvas">
                            </button> -->
                            <span class="material-symbols-outlined" style="font-size: 1.2em; color: rgb(168, 168, 168);">
                                logout
                            </span>
                            <span style="font-size: 0.8em; color: rgb(168, 168, 168);">로그아웃</span>
                        </a>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <!-- canvas 끝 -->

    <!-- 스토리 -->
    <!-- overflow-x: auto; 이 클래스가 적용된 요소는 내용이 요소의 크기를 초과할 때, x축 방향으로 스크롤할 수 있게 됩니다. -->
    <div class="row border-bottom mb-2">
        <!-- 스크롤 바 없애는 거 scrollbar-width: none; _ overflow있는 곳에 넣어주기 -->
        <div class="col overflow-x-auto" style="scrollbar-width: none;">
            <div class="row flex-nowrap"> <!-- flex-nowrap !!!대박!!! 반복문 길이에 자동으로 가로축 맞춰줌!!! -->
                <a class="col-auto link-dark link-offset-2 link-underline link-underline-opacity-0" th:href="@{./instaMyPage(user_id=${instaUserInfoDto.id})}">
                    <div class="row">
                        <div class="col">
                            <div class="row">
                                <div class="col" style="display: inline-block; position: relative; height: 65px;">
                                    <img src="/public/img/instaImage/story.jpg" class="img-fluid rounded-circle storyImg">
                                    <img th:src="|/images/${instaUserInfoDto.insta_profile_img}|" class="img-fluid rounded-circle storyImage" style="position: relative;">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col px-1 py-1 text-center" style="font-size: 0.7em;">
                                    <!-- <span th:text="${instaUserInfoDto.insta_nickname}">닉네임</span> -->
                                    <span>내 프로필</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </a>

                <a class="col-auto px-2 link-dark link-offset-2 link-underline link-underline-opacity-0 " th:href="@{./instaUserPage(user_id=${instaStory.id})}" th:each="instaStory : ${instaStoryList}">
                    <div class="row">
                        <div class="col">
                            <div class="row">
                                <div class="col" style="position: relative; height: 65px;">
                                    <img src="/public/img/instaImage/story.jpg" class="img-fluid rounded-circle storyImg">
                                    <img th:src="|/images/${instaStory.insta_profile_img}|" class="img-fluid rounded-circle storyImage" style="position: relative;" alt="Profile Image">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col px-1 py-1 text-center" style="font-size: 0.7em;">
                                    <span th:text="${instaStory.insta_nickname}">닉네임</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <!-- 게시글 List 출력 -->
    <div class="row mb-4" th:each="instaArticleList : ${instaArticleListAll}">
        <div class="col">
            <div class="row">
                <!-- 글 작성한 사람 프로필 이미지 -->
                <a class="col-auto pe-1 link-dark link-offset-2 link-underline link-underline-opacity-0" style="position: relative;"
                            th:href="${session.sessionUserInfo.id == instaArticleList.instaUserInfoDto.user_id} ?
                                        @{./instaMyPage(user_id=${instaArticleList.instaUserInfoDto.id})} : @{./instaUserPage(user_id=${instaArticleList.instaUserInfoDto.id})}">
                    <!-- <img th:src="|/basecampImage/${instaArticleList.instaArticleDto.insta_profile_img}|" class="img-fluid rounded-circle commentImage"> -->
                    <img src="/public/img/instaImage/story.jpg" class="img-fluid rounded-circle profileImg">
                    <img th:src="|/images/${instaArticleList.instaUserInfoDto.insta_profile_img}|" class="img-fluid rounded-circle profileImage" style="position: relative;">
                </a>
                <!-- 글 작성한 사람 닉네임 -->
                <a class="col-auto ps-0 pt-1 link-dark link-offset-2 link-underline link-underline-opacity-0"
                            th:href="${session.sessionUserInfo.id == instaArticleList.instaUserInfoDto.user_id} ?
                                        @{./instaMyPage(user_id=${instaArticleList.instaUserInfoDto.id})} : @{./instaUserPage(user_id=${instaArticleList.instaUserInfoDto.id})}">
                    <span th:text="${instaArticleList.instaUserInfoDto.insta_nickname}" style="font-size: 0.8em;"></span>
                </a>



                <!-- 오프캠버스의 경우 조건문으로 두가지 이상의 결과를 내야할 때
                        offcanvas id를 조건문에따라서 다르게 해야함 data-bs-target, aria-controls의 이름도 id와 같게 바꿔줘야 함 -->
                <!-- 세션 아이디와 글쓴 사람 아이디가 같을경우 -->
                <!-- <div class="col text-end align-self-center"
                        th:if="${session.sessionUserInfo.id == instaArticleList.instaUserInfoDto.user_id}">
                    <button class="btn p-0" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasMy" aria-controls="offcanvasMy">
                        <i class="bi bi-three-dots"></i>
                    </button>

                    <div class="offcanvas offcanvas-bottom" tabindex="-1" id="offcanvasMy" aria-labelledby="offcanvasBottomLabel">
                        <div class="offcanvas-body pt-2 pt-0">
                            <div class="row text-center fontBasic">
                                <div class="col">
                                    <div class="row border-bottom">
                                        <a class="col link-dark link-underline-opacity-0 py-3" href="./aticleEditPage">
                                            <span>
                                                수정
                                            </span>
                                        </a>
                                    </div>
                                    <div class="row border-bottom">
                                        <a class="col link-dark link-underline-opacity-0 py-3"
                                            th:href="@{./articleDeleteProcess(article_id=${instaArticleList.instaArticleDto.id}, user_id=${session.sessionUserInfo.id})}">
                                            <span style="color: red;">
                                                삭제
                                            </span>
                                        </a>
                                    </div>
                                    <div class="row">
                                        <button type="button" class="col py-4" data-bs-dismiss="offcanvas" aria-label="Close" style="border: none; background-color: white;">
                                            취소
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> -->

                <!-- 모달 _ 자바스크립트로 변경해야 됨 -->
                <!-- 세션 아이디와 글쓴 사람 아이디가 같을경우 -->
                <div class="col text-end align-self-center"
                    th:if="${session.sessionUserInfo.id == instaArticleList.instaUserInfoDto.user_id}">
                    <button class="btn p-0" type="button" data-bs-toggle="modal" data-bs-target="#myModal">
                        <i class="bi bi-three-dots"></i>
                    </button>

                    <!-- Modal -->
                    <div class="modal fade" id="myModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-body">
                                    <div class="row text-center fontBasic">
                                        <div class="col">
                                            <div class="row border-bottom">
                                                <a class="col link-dark link-underline-opacity-0 py-3" href="./aticleEditPage">
                                                    <span>
                                                        수정
                                                    </span>
                                                </a>
                                            </div>
                                            <div class="row border-bottom">
                                                <a class="col link-dark link-underline-opacity-0 py-3"
                                                th:href="@{./articleDeleteProcess(article_id=${instaArticleList.instaArticleDto.id}, user_id=${session.sessionUserInfo.id})}">
                                                    <span style="color: red;">
                                                        삭제
                                                    </span>
                                                </a>
                                            </div>
                                            <div class="row">
                                                <button type="button" class="col py-4" data-bs-dismiss="modal" aria-label="Close" style="border: none; background-color: white;">
                                                    취소
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 모달 _ 자바스크립트로 변경해야 됨 -->
                <!-- 세션 아이디와 글쓴 사람 아이디가 다를경우 -->
                <div class="col text-end align-self-center"
                    th:unless="${session.sessionUserInfo.id == instaArticleList.instaUserInfoDto.user_id}">
                    <button class="btn p-0" type="button" data-bs-toggle="modal" data-bs-target="#userModal">
                        <i class="bi bi-three-dots"></i>
                    </button>

                    <!-- Modal -->
                    <div class="modal fade modal-custom" id="userModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-body">
                                    <div class="row text-center fontBasic">
                                        <div class="col">
                                            <div class="row border-bottom">
                                                <a class="col link-dark link-underline-opacity-0 py-3" href="./aticleBlockPage">
                                                    <span>
                                                        차단
                                                    </span>
                                                </a>
                                            </div>
                                            <div class="row border-bottom">
                                                <a class="col link-dark link-underline-opacity-0 py-3" href="./articleReportPage">
                                                    <span style="color: red;">
                                                        신고
                                                    </span>
                                                </a>
                                            </div>
                                            <div class="row">
                                                <button type="button" class="col py-4" data-bs-dismiss="modal" aria-label="Close" style="border: none; background-color: white;">
                                                    취소
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 해당글 이미지 List -->
            <div class="row mt-2">
                <div class="col px-0">
                    <div th:id="'carouselExampleInterval' + ${instaArticleList.instaArticleDto.id}" class="carousel slide"> <!-- data-bs-ride="carousel" _ 자동 슬라이드를 활성화 -->
                        <!-- 인디케이터 추가 (이미지가 두 개 이상일 때만 표시) _ 이미지 리스트의 크기가 1보다 큰 경우에만 인디케이터와 버튼을 렌더링 -->                            
                        <ol class="carousel-indicators" th:if="${#lists.size(instaArticleList.instaArticleImgDtoList) > 1}">
                            <!-- 이미지 개수만큼 점 생성 -->
                            <li th:each="image, iterStat : ${instaArticleList.instaArticleImgDtoList}"
                                th:classappend="${iterStat.index == 0 ? 'active' : ''}"
                                th:data-bs-slide-to="${iterStat.index}">
                            </li>
                            <!-- iterStat은 Thymeleaf에서 반복문을 사용할 때 제공되는 변수로, 반복 상태를 나타내는 객체입니다.
                                    iterStat을 사용하면 반복문에서 현재 반복의 상태를 추적하고, 인덱스나 반복 횟수와 같은 정보를 얻을 수 있습니다. -->
                        </ol>
                        
                        <div class="carousel-inner">
                            <!-- 이미지도 반복문 -->
                            <div th:each="image, iterStat : ${instaArticleList.instaArticleImgDtoList}"
                                    class="carousel-item"
                                    th:classappend="${iterStat.index == 0 ? 'active' : ''}"> <!-- data-bs-interval="5000" _ 5초에 한번씩 사진 슬라이드 -->
                                    <!-- 타임리프에서 classappend라는 구문을 사용하여 HTML 요소의 class 속성에 동적으로 클래스를 추가할 수 있습니다. -->
                                <img th:src="|/images/${image.img_link}|" class="d-block w-100" style="object-fit: cover; object-position: center; aspect-ratio: 1.3/1;">
                            </div>
                        </div>
                        
                        <button class="carousel-control-prev" type="button" th:data-bs-target="'#carouselExampleInterval' + ${instaArticleList.instaArticleDto.id}"
                                data-bs-slide="prev" th:if="${#lists.size(instaArticleList.instaArticleImgDtoList) > 1}">
                                <!-- 이미지 리스트의 크기가 1보다 큰 경우에만 인디케이터와 버튼을 렌더링 -->
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" th:data-bs-target="'#carouselExampleInterval' + ${instaArticleList.instaArticleDto.id}"
                                data-bs-slide="next" th:if="${#lists.size(instaArticleList.instaArticleImgDtoList) > 1}">
                                <!-- 이미지 리스트의 크기가 1보다 큰 경우에만 인디케이터와 버튼을 렌더링 -->
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 잘못 만든거 -->
            <!-- <div class="row mt-3">
                <div class="col px-0">
                    <div th:id="'carouselExampleInterval' + ${instaArticleList.instaArticleDto.id}" class="carousel slide"> 

                        <ol class="carousel-indicators">
                            
                            <li th:each="image, iterStat : ${instaArticleList.instaArticleImgDtoList}"
                                th:classappend="${iterStat.index == 0 ? 'active' : ''}"
                                th:data-bs-slide-to="${iterStat.index}"></li>
                        </ol>
                        
                        <div class="carousel-inner">
                            
                            <div class="carousel-item active"
                                th:each="image : ${instaArticleList.instaArticleImgDtoList}"> 
                                <img th:src="|/images/${image.img_link}|" class="d-block w-100">
                            </div>
                        </div>
                        <button class="carousel-control-prev" type="button" th:data-bs-target="'#carouselExampleInterval' + ${instaArticleList.instaArticleDto.id}" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" th:data-bs-target="'#carouselExampleInterval' + ${instaArticleList.instaArticleDto.id}" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                        </div>
                </div>
            </div> -->


            <div class="row align-items-center" style="height: 25px;">
                <!-- 좋아요 -->
                <form action="./pushArticleLikeDeleteProcess" method="get" class="col-auto px-0" th:if="${instaArticleList.like == 1}">
                    <button class="btn d-flex align-items-center pb-0">
                        <i class="fa-solid fa-heart likeColor"></i>
                    </button>

                    <input type="hidden" name="user_id" th:value="${instaUserInfoDto.id}">
                    <input type="hidden" name="article_id" th:value="${instaArticleList.instaArticleDto.id}">
                </form>
                <form action="./pushArticleLikeProcess" method="get" class="col-auto px-0" th:if="${instaArticleList.like != 1}">
                    <button class="btn d-flex align-items-center pb-0">
                        <!-- onclick="like(/*[[${instaArticleList.instaArticleDto.id}]]*/)" -->
                        <i id="heart" onclick="like()" class="fa-regular fa-heart"></i>
                    </button>

                    <input type="hidden" name="user_id" th:value="${instaUserInfoDto.id}">
                    <input type="hidden" name="article_id" th:value="${instaArticleList.instaArticleDto.id}">
                </form>

                <!-- 댓글 -->
                <!-- <div class="col px-0">
                    <form action="./commentWritePage" method="get">
                        <button class="btn px-0">
                            <i class="fa-regular fa-comment"></i>
                        </button>
                        <input type="hidden" name="user_id" th:value="${instaUserInfoDto.id}">
                        <input type="hidden" name="article_id" th:value="${instaArticleList.instaArticleDto.id}">
                    </form>
                </div> -->
                <div class="col px-0">
                    <button onclick="reloadCommentList(this)" class="btn pb-0 px-0 d-flex align-items-center" type="button">
                        <i class="fa-regular fa-comment"></i>
                        <input type="hidden" class="inputInstaArticleId" th:value="${instaArticleList.instaArticleDto.id}">
                    </button>

                    <!-- 오프 캠버스 실행 -->
                </div>

                <!-- 북마크 -->
                <form action="./pushBookmarkProcess" method="get" class="col-auto text-end" th:if="${instaArticleList.bookmark != 1}">
                    <button type="submit" class="btn pe-0 pb-0 d-flex align-items-center" onclick="showToast(event)">
                        <i class="fa-regular fa-bookmark"></i>
                    </button>

                    <!-- <input type="hidden" name="user_id" th:value="${session.sessionUserInfo.id}"> -->
                    <input type="hidden" name="user_id" th:value="${instaUserInfoDto.id}">
                    <input type="hidden" name="article_id" th:value="${instaArticleList.instaArticleDto.id}">

                    <!-- 이거 쓰고싶다 -->
                    <div id="toast" class="toast align-items-center text-bg-dark border-0 fade position-fixed" style="bottom: 95px; left: 50%; transform: translate(-50%, -50%); z-index: 2000;" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="toast-body row align-items-center">
                            <div class="col-12 text-center pe-0">
                                북마크 저장 완료
                            </div>
                        </div>
                    </div>
                </form>
                <form action="./pushBookmarkDeleteProcess" method="get" class="col-auto text-end" th:if="${instaArticleList.bookmark == 1}">
                    <button type="submit" class="btn pe-0 pb-0 d-flex align-items-center">
                        <i class="fa-solid fa-bookmark"></i>
                    </button>

                    <input type="hidden" name="user_id" th:value="${instaUserInfoDto.id}">
                    <input type="hidden" name="article_id" th:value="${instaArticleList.instaArticleDto.id}">
                </form>
            </div>

            <!-- 좋아요 수 -->
            <div class="row">
                <a class="col fontBasic link-dark link-offset-2 link-underline link-underline-opacity-0 " href="./pushLikeUserPage">
                    <span>좋아요</span>
                    <span th:text="${instaArticleList.likeCount}"></span><span>개</span>
                </a>
            </div>

            <!-- 글 작성한 사람 닉네임,
                    게시글 작성일,
                    내용 -->
            <div class="row justify-content-center">
                <!-- <a class="col-auto fontBasic pe-0 link-dark link-offset-2 link-underline link-underline-opacity-0" href="./instaUserPage">
                    <span th:text="${instaArticleList.instaUserInfoDto.insta_nickname}"></span>
                </a> -->
                <a class="col-auto d-flex align-items-center pe-0 link-dark link-offset-2 link-underline link-underline-opacity-0"
                            th:href="${session.sessionUserInfo.id == instaArticleList.instaUserInfoDto.user_id} ?
                                        @{./instaMyPage(user_id=${instaArticleList.instaUserInfoDto.id})} : @{./instaUserPage(user_id=${instaArticleList.instaUserInfoDto.id})}">
                    <!-- <span class="fontBasic">saram</span> -->
                    <span class="fontBasic" th:text="${instaArticleList.instaUserInfoDto.insta_nickname}"></span>
                </a>
                <div class="col-auto fontBasic ps-1 pe-0">
                    <span th:text="${T(com.bulmeong.basecamp.common.util.TimeUtil).timeAgo(instaArticleList.instaArticleDto.created_at)}" style="color: rgb(162, 162, 162);"></span>                                             
                </div>
                <div class="col ps-1 fontBasic">
                    <span th:utext="${instaArticleList.instaArticleDto.content}">good day✨</span>   
                </div>
            </div>
            <!-- 해시태그 -->
            <div class="row">
                <a th:href="@{./instaSearchHashTagClickResultPage(tag_id=${hashtag.id}, user_id=${instaUserInfoDto.id})}" 
                    class="col-auto fontBasic pe-0 lightFont" 
                    th:each="hashtag, iterStat : ${instaArticleList.hashtags}" 
                    th:classappend="${iterStat.index > 0} ? ' ps-0'"> <!-- 첫 번째 이후의 모든 해시태그에 ps-0 클래스를 추가 -->
                    <span th:utext="${hashtag.text}" class="hashtag">해시태그</span>
                </a>
            </div>

            <!-- 댓글 -->
            <div class="row">
                <!-- <a class="col link-dark link-offset-2 link-underline link-underline-opacity-0"
                    th:href="@{./commentWritePage(user_id=${instaUserInfoDto.id}, article_id=${instaArticleList.instaArticleDto.id})}">
                    <span class="fontBasic" style="color: rgb(162, 162, 162);">댓글
                        <span th:text="${instaArticleList.commentCount}"></span>개 모두 보기
                    </span>
                </a> -->
                <div class="col">
                    <button onclick="reloadCommentList(this)" class="btn p-0 comment-button" type="button">
                        <span class="fontBasic" style="color: rgb(162, 162, 162);">댓글
                            <span th:text="${instaArticleList.commentCount}"></span>개 모두 보기
                        </span>
                        <input type="hidden" class="inputInstaArticleId" th:value="${instaArticleList.instaArticleDto.id}">
                    </button>
                </div>
            </div>

            <!-- 댓글 작성 -->
            <!-- <div class="row">
                <div class="col-auto pe-0">
                    <img th:src="|/images/${instaUserInfoDto.insta_profile_img}|" class="img-fluid rounded-circle commentImage">
                </div>
                <a class="col ps-1 link-dark link-offset-2 link-underline link-underline-opacity-0"
                    th:href="@{./commentWritePage(user_id=${instaUserInfoDto.id}, article_id=${instaArticleList.instaArticleDto.id})}">
                    <span class="fontBasic" style="color: rgb(162, 162, 162);">댓글 달기...</span>
                </a>
            </div> -->

            <div class="row">
                <div class="col-auto pe-0">
                    <!-- 로그인한 유저 프로필 -->
                    <!-- <img th:src="|/basecampImage/${session.instaUserInfoDto.insta_profile_img}|" class="img-fluid rounded-circle commentImage"> -->
                    <img th:src="|/images/${instaUserInfoDto.insta_profile_img}|" class="img-fluid rounded-circle commentImage">
                </div>
                <div class="col ps-1">
                    <button onclick="reloadCommentList(this)" class="btn p-0" type="button" style="line-height: 1px;">
                        <span class="fontBasic" style="color: rgb(162, 162, 162);">댓글 달기...</span>
                        <input type="hidden" class="inputInstaArticleId" th:value="${instaArticleList.instaArticleDto.id}">
                    </button>

                    <!-- 오프 캠버스 실행 -->
                </div>
            </div>

        </div>
    </div>

    <!-- <div class="write-button-container">
        <form action="./instaWritePage" method="get">
            <button class="btn write-button" type="submit" style="background-color: white;">
                <i class="bi bi-plus-square fs-2"></i>
            </button>
        </form>
    </div> -->

    <!-- 글쓰기 버튼 -->
    <div class="row write-button-container">
        <!-- style="aspect-ratio: 1/1;" -> 익스펙토 주문 : 정방향을 만들어준다 -->
        <form class="col" action="./instaWritePage" method="get">
            <button class="btn rounded-circle" type="submit" style="aspect-ratio: 1/1; background-color: #28323C; float: right;">
                <i class="fa-solid fa-plus text-white" style="font-size: 1.5em;"></i>
                <input type="hidden" name="user_id" th:value="${instaUserInfoDto.id}">
            </button>
        </form>
    </div>

    <!-- <div class="write-button-container">
        <form action="./instaWritePage" method="get">
            <button class="btn bg-white rounded-2 border border-2 border-black px-2 py-1" type="submit">
                <i class="fa-solid fa-plus"></i>
                <input type="hidden" name="user_id" th:value="${instaUserInfoDto.id}">
            </button>
        </form>
    </div> -->

    <!-- 글쓰기 페이지 -->
    <!-- <form class="row fixed-bottom fixed-write-button" action="./instaWritePage" method="get">
        <div class="col-10"></div>
        <div class="col-2">
            <button class="btn" type="submit">
                <i class="bi bi-plus-square fs-2 write-button"></i>
            </button>
        </div>
    </form> -->
    
</div>

<!--커뮤니티 하단네비 -->
<div th:fragment="bottomNaviBasecamp" class="container-fluid g-0 border-top bg-white fixed-bottom pb-3">
    <div class="row mx-1 py-2 text-center">
        
        <!--HOME-->
        <a href="/" class="col icon-and-text">
            <span class="material-symbols-outlined fw-light" style="font-size: 1.8em; color: darkgray;">
                home
            </span>
            <span class="text-navi pt-1" style="font-size: 0.7em; color: darkgray">홈</span>
        </a>        

        <!--구매-->
        <div class="col icon-and-text dropdown dropup">
            <span data-bs-toggle="dropdown" class="material-symbols-outlined fw-light" style="font-size: 1.7em; color: darkgray;">
                storefront
            </span>
            <span class="text-navi pt-1" style="font-size: 0.7em; color: darkgray;">구매</span>
            <ul class="dropdown-menu custom-dropdown-menu">
                <!-- 변초연 -->
                <a class="dropdown-item col" href="/store">
                    <div class="row w-100">
                        <div class="col-auto d-flex">
                            <span class="material-symbols-outlined pe-1 ps-1 fw-light">
                                shopping_bag
                            </span>
                            <span style="font-size: 0.9em;">스토어</span>
                        </div>
                    </div>
                </a>
                <!-- 심규진 -->
                <a class="dropdown-item col" href="/secondhandProduct/mainPage">
                    <div class="row w-100">
                        <div class="col-auto d-flex">
                            <span class="material-symbols-outlined pe-1 ps-1 fw-light">
                                eco
                            </span>
                            <span style="font-size: 0.9em;">중고</span>
                        </div>
                    </div>
                </a>
            </ul>
        </div>

        <!--예약-->
        <div class="col icon-and-text dropdown dropup">
            <span data-bs-toggle="dropdown" class="material-symbols-outlined fw-light" style="font-size: 1.7em; color: darkgray;">
                event_available
            </span>
            <span class="text-navi pt-1" style="font-size: 0.7em; color: darkgray;">예약</span>
            <ul class="dropdown-menu row custom-dropdown-menu">
                <!-- 조준희 -->
                <a class="dropdown-item col" href="/camp/main">
                    <div class="row w-100">
                        <div class="col-auto d-flex">
                            <span class="material-symbols-outlined pe-1 ps-1 fw-light">
                                camping
                            </span>
                            <span style="font-size: 0.9em;">캠핑장</span>
                        </div>
                    </div>
                </a>
                <!-- 양은자 -->
                <a class="dropdown-item col" href="/campingcar/main">
                    <div class="row w-100">
                        <div class="col-auto d-flex">
                            <span class="material-symbols-outlined pe-1 ps-1 fw-light">
                                airport_shuttle
                            </span>
                            <span style="font-size: 0.9em;">캠핑카</span>
                        </div>
                    </div>
                </a>
            </ul>
        </div>

        <!--커뮤-->
        <div class="col icon-and-text dropdown dropup">
            <span data-bs-toggle="dropdown" class="material-symbols-outlined" style="font-size: 1.7em;">
                forum
            </span>
            <span class="text-navi pt-1 fw-bold" style="font-size: 0.7em;">커뮤니티</span>
            <ul class="dropdown-menu custom-dropdown-menu">
                <!-- 이시은 -->
                <a class="dropdown-item col" href="/club/main">
                    <div class="row w-100">
                        <div class="col-auto d-flex">
                            <span class="material-symbols-outlined pe-1 ps-1 fw-light">
                                group
                            </span>
                            <span style="font-size: 0.9em;">소모임</span>
                        </div>
                    </div>
                </a>
                <!-- 남현지 -->
                <a class="dropdown-item col" href="/insta/instaMainPage">
                    <span>
                        <img src="/public/img/instaImage/campstagram.png" class="img-fluid">
                    </span>
                </a>
            </ul>
        </div>
        
        <!--내정보-->
        <!-- <a class="col icon-and-text" href="/user/login" th:if="${session.sessionUserInfo == null}">
            <span class="material-symbols-outlined pe-1 ps-1 fw-light"style="font-size: 1.7em; color: darkgray;">
                person
            </span>
            <span class="text-navi pt-1" style="font-size: 0.7em; color: darkgray;">마이</span>
        </a>
        <a class="col icon-and-text" href="/user/myPage" th:unless="${session.sessionUserInfo == null}">
            <span class="material-symbols-outlined pe-1 ps-1 fw-light"style="font-size: 1.7em; color: darkgray;">
                person
            </span>
            <span class="text-navi pt-1" style="font-size: 0.7em; color: darkgray;">마이</span>
        </a> -->

        <!--canvas 버튼-->
        <div class="col">
            <button class="btn py-0" style="font-size: 1.7em; color: darkgray; line-height: 1px;" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight">
                <span class="material-symbols-outlined">
                    menu
                </span>
            </button>
            <div class="row">
                <div class="col">
                    <span style="font-size: 0.7em; color: darkgray;">
                        메뉴
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- 댓글 오프캠버스 -->
<div class="offcanvas offcanvas-bottom" tabindex="-1" id="offcanvasComment" aria-labelledby="offcanvasBottomLabel">
    <div class="offcanvas-header p-0">
        <div class="row w-100 m-0">
            <div class="col d-flex justify-content-center p-0">
                <button onclick="cHide()" class="btn p-0 m-0" type="button" style="line-height: 0.5;">
                    <i class="bi bi-dash-lg" style="font-size: 2em; color: rgb(162, 162, 162);"></i>
                </button>
            </div>
        </div>
    </div>
    <div class="offcanvas-header p-0">
        <div class="row border-bottom w-100 m-0">
            <div class="col fw-bold fontNine pb-2 d-flex justify-content-center">
                <span>댓글</span>
            </div>
        </div>
    </div>
    

    <div class="offcanvas-body pt-0">
        
        <!-- 댓글 List 박스 -->
        <div class="instaArticleRow row pb-5 mb-3">
            <div id="commentListBox" class="col fontBasic">

            </div>
        </div>


        <div class="row qqq border-top fixed-bottom px-3" style="background-color: white;">
            <!-- 로그인 한 유저 프로필 사진 -->
            <div class="col-auto ps-4 pe-2">
                <img th:src="|/images/${instaUserInfoDto.insta_profile_img}|" class="img-fluid rounded-circle commentWriteImage" alt="Profile Image">
            </div>

            <!-- 댓글 작성 form -->
            <!-- <div class="col">
                <form class="row">
                    <div class="col align-self-center pe-0">
                        <input id="inputText" type="text" class="rounded-5 form-control form-control-sm py-2" placeholder="댓글 추가..." style="font-size: 0.8em;">
                    </div>
                    <div class="col-auto align-self-center ps-1">
                        <button onclick="registerComment()" class="btn rounded-5 px-3 py-1" type="submit" style="color: white; background-color: #0095f6;">
                            <i class="fa-solid fa-arrow-up"></i>
                        </button>
                    </div>
                </form>
            </div> -->

            <!-- 자바스크립트로 처리하기때문에 form태그가 필요하지않음 -->
            <div class="col">
                <div class="row">
                    <div class="col">
                        <input id="inputText" class="py-2 form-control rounded-5 fontBasic" placeholder="댓글 추가...">
                        <!-- <textarea  class="form-control "></textarea> -->
                    </div>
                    <div class="col-auto p-0">
                        <!-- <input onclick="registerComment()" type="button" class="btn btn-primary" value="등록"> -->
                        <button id="registerCrButton" class="send-icon btn rounded-5 px-3 py-1" type="submit" style="color: white; background-color: #00B8FF;">
                            <i class="fa-solid fa-arrow-up send-icon i" style="padding-right: 20%;"></i>
                        </button> <!-- registerCommentButton -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 하나의 댓글 _ List를 돌게 됨 -->
<!-- display-none = 안에 있는 내용은 보이지 않음 -->
<div id="templete" class="d-none">
    <!-- 하나의 댓글 -->
    <div class="commentWrapper row mt-1">
        <div class="col mt-3">
            <div class="row pe-1 align-items-center">
                <a class="col-auto pe-0 align-self-center link-dark link-offset-2 link-underline link-underline-opacity-0" href="./instaUserPage" style="position: relative;">
                    <img src="/public/img/instaImage/story.jpg" class="img-fluid rounded-circle commentWriteImg" style="position: relative; z-index: 1;">
                    <img class="commentProfile img-fluid rounded-circle commentWriteImage" style="position: absolute; left: 12px; z-index: 2;">
                </a>
                <div class="col">
                    <div class="row align-items-center">
                        <a class="commentName col-auto pe-0 link-dark link-offset-2 link-underline link-underline-opacity-0" href="./instaUserPage">
                            닉네임
                        </a>
                        <div class="commentDate col-auto ps-1 pe-0 fontNine" style="color: rgb(162, 162, 162); padding-top: 0.5%;">날짜</div>
                        <!-- 삭제버튼 -->
                        <div class="commentDeleteButton d-none col" style="color: rgb(162, 162, 162);">
                            <span class="buttonDelete">
                                <i class="fa-duotone fa-solid fa-xmark"></i>
                            </span>
                        </div>                                                                          
                    </div>
                    <div class="row">
                        <div class="commentText col pe-0">내용</div>
                    </div>
                </div>

                <!-- 좋아요 -->
                <div class="col-auto align-self-center">
                    <div class="row">
                        
                        <!-- 좋아요 안 눌렀을 때 -->
                        <div class="likeButton col align-self-center d-none">
                            <span>
                                <i class="fa-regular fa-heart"></i>
                            </span>
                        </div>

                        <!-- 좋아요 눌렀을 때 -->
                        <div class="unLikeButton col align-self-center d-none">
                            <span>
                                <i class="fa-solid fa-heart likeColor"></i>
                            </span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col p-0 fontNine text-center">
                            <span class="likeCount">4</span>
                        </div>
                    </div>
                </div>

                <!-- 인스타모양 삭제 버튼 -->
                <!-- col이 row 안에 꽉차게 만들어줌 -->
                <!-- <div class="commentDeleteButton d-none col-auto align-self-stretch fs-5 bg-danger px-1 d-flex align-items-center" style="color: white;">
                    <span class="buttonDelete">
                        <i class="fa-solid fa-trash"></i>
                    </span>
                </div> -->
            </div>
            <div class="row">
                <div class="col-2"></div>

                <!-- hidden은 레이아웃은 잡아주되 안 쪽에 내용을 보이지않게 함 -->
                <!-- d-none은 크기 자체가 없음 -->
                <div onclick="focusOnReplyInput(this.closest('.commentWrapper'))" class="commentReply col fontNine pe-0" style="padding-left: 6px; color: rgb(162, 162, 162);">
                    <span>답글 달기</span>
                </div>
            </div>

            <!-- 답글 보기/숨기기 버튼 추가 -->
            <!-- <div class="row mt-3">
                <div class="replyToggle col fontNine pe-0" style="padding-left: 16.5%; color: rgb(162, 162, 162); cursor: pointer;" onclick="toggleReplies(this)">
                    <span>--------- 답글 <span class="replyCount">1개 </span>보기</span>
                </div>
            </div> -->

            <!-- 대댓글 템플릿 -->
            <div class="row">

                <!-- 답글 보기/숨기기 버튼 추가 -->
                <div class="replyToggle col-12 fontNine mt-3" style="padding-left: 18%; color: rgb(162, 162, 162); cursor: pointer; display: none;" onclick="toggleReplies(replyWrapper, this)">
                    <span>
                        <!-- <span class="material-symbols-outlined fw-light">
                        horizontal_rule
                        </span>  -->
                        ㅡ 
                        답글 <span class="replyCount"></span>개 보기
                    </span>
                </div>

                <!-- 대댓글 리스트 -->
                <div class="col-12 replyWrapper">

                </div>
            </div>

        </div>
    </div>


    <!-- 하나의 대댓글 -->
    <div class="replyTemplete row mt-3" style="padding-left: 16.5%;">
        <div class="col">
            <div class="row pe-1">    
                <a class="col-auto pe-0 link-dark link-offset-2 link-underline link-underline-opacity-0" href="./instaUserPage" style="position: relative;">
                    <img src="/public/img/instaImage/story.jpg" class="img-fluid rounded-circle replyWriteImg" style="position: relative; z-index: 1;">
                    <img class="replyProfile img-fluid rounded-circle replyWriteImage" style="position: absolute; left: 12px; z-index: 2;">
                </a>
                <div class="col align-self-center">
                    <div class="row">
                        <a class="replyName col-auto pe-0 link-dark link-offset-2 link-underline link-underline-opacity-0" href="./instaUserPage">
                            닉네임
                        </a>
                        <div class="replyDate col-auto ps-1 pe-0 fontNine" style="color: rgb(162, 162, 162); padding-top: 0.5%;">날짜</div>
                        <!-- 삭제버튼 -->
                        <div class="replyDeleteButton d-none col" style="color: rgb(162, 162, 162);">
                            <span class="buttonDelete">
                                <i class="fa-duotone fa-solid fa-xmark"></i>
                            </span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="replyText col pe-0">내용</div>
                    </div>
                </div>

                <!-- 대댓글 좋아요 -->
                <div class="col-auto align-self-center">
                    <div class="row">

                        <!-- 이거 삭제하셈 레이아웃때문에 -->
                        <div class="col">
                            <span>
                                <i class="fa-regular fa-heart"></i>
                            </span>
                        </div>
                        
                        <!-- 좋아요 안 눌렀을 때 -->
                        <div class="likeReplyButton col align-self-center d-none">
                            <span>
                                <i class="fa-regular fa-heart"></i>
                            </span>
                        </div>

                        <!-- 좋아요 눌렀을 때 -->
                        <div class="unLikeReplyButton col align-self-center d-none">
                            <span>
                                <i class="fa-solid fa-heart likeColor"></i>
                            </span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col p-0 fontNine text-center">
                            <span class="likeReplyCount">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="https://kit.fontawesome.com/7b271bba58.js" crossorigin="anonymous"></script>

<script>
    const urlParams = new URL(window.location.href).searchParams;
    // const articleId = urlParams.get("article_id");

    // myId =  session아이디 _ 글로벌 변수 
    let myId = null;
    let myInstaId = null;

    let isReply = false; // 대댓글 여부를 추적하는 변수
    let parentCommentId = null; // 대댓글의 부모 댓글 ID

    let articleId = null; // 현재 처리 중인 기사 ID
    let reloadButton = null; // 현재 처리 중인 버튼 요소

    function setSessionId(){
        const url = "/api/user/getSessionUserId";
        fetch(url)
        .then(response => response.json())
        .then((response) => { // 응답 받은 시점

            myId = response.data.userId;
            // reloadHeart();
            console.log("Session ID :", myId); // 콘솔에 찍힐 세션 id
        });
    }

    function setMyInstaId(){
        const url = "/api/insta/getMyInstaId";

        fetch(url)
        .then(response => response.json())
        .then((response) => {
            myInstaId = response.data.myInstaId

            console.log("sessionGetInstaId ID :", myInstaId); // 콘솔에 찍힐 세션 id
        })
        ;
    }

    function like(){
        const url = "/api/insta/like?article_id=" + articleId;
        if(myId == null){
            if(confirm("로그인 후 이용부탁드립니다. 로그인 페이지로 이동하시겠습니까?")){
                location.href = "/insta/instaLoginPage";
            }
            return;
        }

        fetch(url)
            .then(response => response.json())
            .then(response => {
                reloadHeart();
            })
            ;
    }

    // function reloadHeart() {
    //     if(myId == null){
    //         return;
    //     }
        
    //     const url = "/api/insta/isLiked?article_id=" + articleId;
    //     fetch(url)
    //         .then(response => response.json())
    //         .then(response => {

    //             const heart = document.getElementById("heart");

    //             if(response.data.isLiked == true){ // 내가 이 article에 좋아요를 누른거
    //                 heart.classList.remove("bi-heart"); // 'fa-regular fa-heart' => 공백 제거를 위해 쉼표로 나눠서 작성
    //                 heart.classList.add("bi-heart-fill");

    //                 heart.onclick = unLike;
    //             }else{ // 좋아요 안 누른거
    //                 heart.classList.remove("bi-heart-fill");
    //                 heart.classList.add("bi-heart");

    //                 heart.onclick = like;
    //             }
    //         })
    //         ;

    // }

    function unLike(){

        if(myId == null){
            if(confirm("로그인 후 이용부탁드립니다. 로그인 페이지로 이동하시겠습니까?")){
                location.href = "/insta/instaLoginPage";
            }
            return;
        }

        const url = "/api/insta/unLike?article_id=" + articleId;

        fetch(url)
        .then(response => response.json())
        .then(response => {
            reloadHeart();
        })
        ;
    }


    // aHide 함수는 오프캔버스를 닫는 역할을 합니다.
    function cHide() {
        // 오프캔버스를 닫기
        const c = bootstrap.Offcanvas.getOrCreateInstance("#offcanvasComment");
        c.hide();

        // 인풋 창의 내용 삭제
        const inputTextComment = document.getElementById("inputText");
        const inputTextReply = document.getElementById("inputText");
        if (inputTextReply, inputTextComment) {
            inputTextComment.value = "";
            inputTextReply.value = ""; // 인풋 창 초기화
        }
    }

    document.getElementById('registerCrButton').onclick = function(event) {
        // 이벤트 핸들러 내에서 클릭된 버튼 요소를 가져옵니다.
        const clickedButton = document.querySelector("button[onclick^='reloadCommentList']");
        reloadButton = clickedButton.closest('.row').querySelector('button');

        if(isReply) {
            console.log("Attempting to register reply for comment ID:", parentCommentId);
            registerReply(parentCommentId, reloadButton); // reloadButton 전달
        } else {
            console.log("Attempting to register comment for article ID:", articleId);
            registerComment(articleId, reloadButton); // reloadButton 전달
        }
    }


    // 댓글 insert _ post방식으로 작성
    function registerComment(articleId, reloadButton){    
        // console.log("reloadButton:", reloadButton); // 매개변수로 전달된 버튼 요소 출력            

        if(myInstaId == null){
            if(confirm("로그인 하셔야 이용 가능합니다. 로그인 페이지로 이동하시겠습니까?")){
                location.href = "/insta/instaLoginPage";
            }
            return;
        }

        /* html textarea에 작성된 내용을 JavaScript로 가져와서 서버에 전달하는 과정에서 getElementById 메소드를 사용합니다.
        이 메소드는 특정 ID를 가진 HTML 요소를 선택하고, 그 요소의 값을 읽어올 수 있게 해줍니다. */
        const inputTextComment = document.getElementById("inputText");

        // const = JavaScript에서 변수를 선언하는 키워드
        const url = "/api/insta/registerComment";

        /* fetch = JavaScript에서 네트워크 요청을 보내는 함수입니다. 이는 HTML form을 사용하여 서버에 데이터를 제출하는 것과 비슷합니다.
        그러나 fetch는 더 유연하고, 비동기적으로 작동하여 페이지를 다시 로드하지 않고 서버와 통신할 수 있습니다. */
        fetch(url, {
            method: "post",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded" // 나중에 필요시 multipart/formdata, json
            },
            /* 바디에 값을 보낼 때 헤더즈 인코딩 형태에따라서 달라짐
                urlencoded = 문자로 보냄, multipart/formdata = formdata라는 클래스를 활요해서 보냄, json = {}로 묶어서 보냄 _ 받는 쪽에서 좀 다르게 받음 */
            body: `article_id=${articleId}&comment=${inputTextComment.value}`
        })
        .then(response => response.json())
        .then(response => {
            // 대댓글 모드 초기화
            isReply = false;
            parentCommentId = null;

            // 응답 이후에
            inputTextComment.value = ""; // inputTextComment.value 초기화

            // 댓글을 insert 한 후에 바로 reloadCommentList(); 실행
            reloadCommentList(reloadButton);
        })
        ;

    }


    // 댓글 List
    function reloadCommentList(reloadButton){
        if (!reloadButton) {
        console.error("reloadButton이 undefined입니다. 올바른 버튼 요소를 전달하세요.");
        return;
        }

        // 절대 경로 사용
        const articleId = reloadButton.querySelector(".inputInstaArticleId").value;
        const url = `/api/insta/getCommentList?article_id=${articleId}`;

        fetch(url)
        .then(response => response.json())
        .then(response => {
            // console.log("reloadButton:", reloadButton); // 매개변수로 전달된 버튼 요소 출력

            const c = bootstrap.Offcanvas.getOrCreateInstance("#offcanvasComment");
            c.show();

            // 새로고침 후 등록 버튼 클릭 이벤트 설정
            document.getElementById("registerCrButton").onclick = function () {
                if(isReply) {
                    registerReply(parentCommentId, reloadButton);
                } else {
                    registerComment(articleId, reloadButton);
                }
            };

            // document.getElementById("registerCommentButton").setAttribute("onclick", `registerComment(${articleId}, reloadButton)`)

            // 응답 이후에
            // console.log(response); _ console에 reloadCommentList(); 찍어서 확인 가능

            const commentListBox = document.getElementById("commentListBox");
            commentListBox.innerHTML = "";

            const commentWrapperTemplete = document.querySelector("#templete .commentWrapper");

            // c = map
            for(const c of response.data.commentList){
                const newCommentWrapper = commentWrapperTemplete.cloneNode(true);

                // querySelector = 배열이 아니고 단일 엘리먼트들을 리턴해줌
                // queryAll = 배열을 리턴
                const commentName = newCommentWrapper.querySelector(".commentName"); // 닉네임
                commentName.innerText = c.instaUserInfoDto.insta_nickname;

                // 댓글 작성자의 닉네임을 data-username 속성에 저장
                newCommentWrapper.setAttribute("data-userCommentNickname", c.instaUserInfoDto.insta_nickname);
                // 댓글 요소에 comment_id를 data-comment-id로 설정
                newCommentWrapper.setAttribute("data-comment-id", c.instaArticleCommentDto.id);
                //console.log(c.instaArticleCommentDto.id); // 콘솔에 댓글 ID 출력


                const commentText = newCommentWrapper.querySelector(".commentText"); // 내용
                commentText.innerText = c.instaArticleCommentDto.comment;

                const commentDate = newCommentWrapper.querySelector(".commentDate"); // 날짜
                // const date = new Date(c.instaArticleCommentDto.created_at);
                const createdAt = new Date(c.instaArticleCommentDto.created_at);

                // commentDate.innerText = `${date.getFullYear()}.${date.getMonth()+1}.${date.getDate()}`; // 기존 시간 출력 코드

                // 상대 시간 계산 및 설정
                const replyDiffInSeconds = Math.floor((new Date() - createdAt) / 1000);
                const rtf = new Intl.RelativeTimeFormat('ko', { numeric: 'auto' });

                let formattedDate;
                if (replyDiffInSeconds < 60) {
                    formattedDate = rtf.format(-replyDiffInSeconds, 'second');
                } else if (replyDiffInSeconds < 3600) {
                    formattedDate = rtf.format(-Math.floor(replyDiffInSeconds / 60), 'minute');
                } else if (replyDiffInSeconds < 86400) {
                    formattedDate = rtf.format(-Math.floor(replyDiffInSeconds / 3600), 'hour');
                } else {
                    formattedDate = rtf.format(-Math.floor(replyDiffInSeconds / 86400), 'day');
                }

                commentDate.innerText = formattedDate;


                // console.log("myInstaId:", myInstaId);
                // console.log("user_id:", e.instaArticleCommentDto.user_id);
                

                if(myInstaId != null && c.instaArticleCommentDto.user_id == myInstaId){ // 댓글 삭제
                    const commentDeleteButton = newCommentWrapper.querySelector(".commentDeleteButton");
                    commentDeleteButton.classList.remove("d-none");

                    // const buttonDelete = newCommentWrapper.querySelector(".commentDeleteButton");

                    // 댓글 삭제 쿼리 _ 기존 삭제 코드
                    // commentDeleteButton.setAttribute("onclick", `deleteComment(${c.instaArticleCommentDto.id})`);

                    commentDeleteButton.onclick = function() {deleteComment(c.instaArticleCommentDto.id, reloadButton);};

                }

                // 댓글 수정 영상 1시간 48분부터

                // commentProfile 프로필
                const commentProfile = newCommentWrapper.querySelector(".commentProfile");
                commentProfile.setAttribute("src", `/images/${c.instaUserInfoDto.insta_profile_img}`)
                

                // commentLike 좋아요
                // const commentLike = newCommentWrapper.querySelector(".commentLike");
                // commentLike.innerText = e.instaUserInfoDto.insta_nickname;
                const likeButton = newCommentWrapper.querySelector(".likeButton");
                // likeButton.setAttribute("onclick", `commentLike(${c.instaArticleCommentDto.id})`); // 기존 좋아요 코드
                likeButton.onclick = function() {commentLike(c.instaArticleCommentDto.id, reloadButton);};
                // likeButton에 이벤트 핸들러인 onclick 속성을 세팅하고, function() { ... } 부분은 익명 함수로, 이벤트가 발생할 때 실행될 코드를 정의 함
                
                const unLikeButton = newCommentWrapper.querySelector(".unLikeButton");
                // unLikeButton.setAttribute("onclick", `commentUnLike(${c.instaArticleCommentDto.id})`); // 기존 좋아요 취소 코드
                unLikeButton.onclick = function() {commentUnLike(c.instaArticleCommentDto.id, reloadButton);};
                
                // 좋아요 유무 확인
                commentIsLiked(c.instaArticleCommentDto.id, likeButton, unLikeButton);

                // 좋아요 카운트
                const likeCount = newCommentWrapper.querySelector(".likeCount");
                commentLikeCount(c.instaArticleCommentDto.id, likeCount);




                // 대댓글 템플릿 요소 선택
                const replyWrapper  = newCommentWrapper.querySelector(".replyWrapper");
                const replyTemplete = document.querySelector("#templete .replyTemplete")

                // 답글 열고 닫는 쿼리
                const replyToggle = newCommentWrapper.querySelector(".replyToggle");
                const replyCount = c.replyCount || 0;

                // 답글 개수에 따라 답글 보기/숨기기 버튼 설정
                if (replyCount > 0) {
                    replyToggle.style.display = 'block';
                    replyToggle.querySelector('.replyCount').textContent = replyCount;
                    replyToggle.onclick = function() { 
                        toggleReplies(replyWrapper, replyToggle); 
                    }; // 토글 버튼에 클릭 이벤트 추가
                } else {
                    replyToggle.style.display = 'none';
                }

                // 대댓글 목록 반복
                for(const r of c.replyList){
                    const newReplyTemplate = replyTemplete.cloneNode(true);

                    // 대댓글 세부 정보 설정
                    const replyName = newReplyTemplate.querySelector(".replyName"); // 대댓글 닉네임
                    replyName.innerText = r.instaUserInfoDtoReply.insta_nickname;

                    // const replyText = newReplyWrapper.querySelector(".replyText");
                    // replyText.innerText = r.instaArticleReplyDto.reply;



                    // 대댓글 내용 @닉네임 부분만 파랗게 출력하기위한 코드 작성 _ 뭔 코드인지 모름 지피티 작품
                    const replyText = newReplyTemplate.querySelector(".replyText");

                    // 정규 표현식 패턴을 사용하여 닉네임 추출
                    const regex = /@(\S+)/;
                    const matches = regex.exec(r.instaArticleReplyDto.reply);

                    if (matches) {
                    // 닉네임과 나머지 내용을 분리
                    const nickname = matches[0]; // '@닉네임'
                    const restOfContent = r.instaArticleReplyDto.reply.slice(matches.index + matches[0].length);

                    // <span> 요소로 감싸고 색상 스타일 추가
                    replyText.innerHTML = `<span style="color: #3A668C;">${nickname}</span>${restOfContent}`;
                    } else {
                    // 매치가 없으면 전체 내용을 기본 스타일로 출력
                    replyText.innerText = r.instaArticleReplyDto.reply;
                    }




                    const replyDate = newReplyTemplate.querySelector(".replyDate"); // 대댓글 날짜
                    const replyCreatedAt = new Date(r.instaArticleReplyDto.created_at);

                    const replyDiffInSeconds = Math.floor((new Date() - replyCreatedAt) / 1000);
                    const rtf2 = new Intl.RelativeTimeFormat('ko', { numeric: 'auto' });

                    let replyFormattedDate;
                    if (replyDiffInSeconds < 60) {
                        replyFormattedDate = rtf2.format(-replyDiffInSeconds, 'second');
                    } else if (replyDiffInSeconds < 3600) {
                        replyFormattedDate = rtf2.format(-Math.floor(replyDiffInSeconds / 60), 'minute');
                    } else if (replyDiffInSeconds < 86400) {
                        replyFormattedDate = rtf2.format(-Math.floor(replyDiffInSeconds / 3600), 'hour');
                    } else {
                        replyFormattedDate = rtf2.format(-Math.floor(replyDiffInSeconds / 86400), 'day');
                    }

                    replyDate.innerText = replyFormattedDate;

                    const replyProfile = newReplyTemplate.querySelector(".replyProfile"); // 대댓글 작성 유저 프로필
                    replyProfile.setAttribute("src", `/images/${r.instaUserInfoDtoReply.insta_profile_img}`);

                    // 대댓글 삭제
                    if(myInstaId != null && r.instaArticleReplyDto.user_id == myInstaId){
                        const replyDeleteButton = newReplyTemplate.querySelector(".replyDeleteButton");
                        replyDeleteButton.classList.remove("d-none");
                        replyDeleteButton.onclick = function() { deleteReply(r.instaArticleReplyDto.id, reloadButton); };
                    }

                    
                    // 대댓글 좋아요
                    // const likeReplyButton = newReplyWrapper.querySelector(".likeReplyButton");
                    // likeReplyButton.onclick = function() { replyLike(r.instaArticleReplyDto, reloadButton); };

                    // const unLikeReplyButton = newReplyWrapper.querySelector(".unLikeReplyButton");
                    // unLikeReplyButton.onclick = function() {replyUnLike(r.instaArticleReplyDto.id, reloadButton); };

                    // replyIsLiked(r.instaArticleReplyDto.id, likeReplyButton, unLikeReplyButton);

                    // const likeReplyCount = newReplyWrapper.querySelector(".likeReplyCount");
                    // replyLikeCount(r.instaArticleReplyDto.id, likeReplyCount);


                    // 대댓글 요소를 댓글 요소에 추가
                    replyWrapper.appendChild(newReplyTemplate)
                }

                commentListBox.appendChild(newCommentWrapper);
            }

        });
    }


    // 댓글 삭제
    function deleteComment(commentId, reloadButton) { // 몇번 댓글을 삭제할지 변수를 받아야 함

        if (confirm("댓글을 삭제하시겠습니까?")) {
            const url = "/api/insta/deleteComment?id=" + commentId;
            
            fetch(url)
            .then(response => response.json())
            .then(response => {

                reloadCommentList(reloadButton);
            });
        }
    }

    // 대댓글 삭제
    function deleteReply(replyId, reloadButton) {

        if (confirm("답글을 삭제하시겠습니까?")) {
            const url = "/api/insta/deleteReply?id=" + replyId;

            fetch(url)
            .then(response => response.json())
            .then(response => {

                reloadCommentList(reloadButton);
            });
        }
    }


    // 댓글 좋아요
    function commentLike(commentId, reloadButton) {

        if(myInstaId == null) {
            if(confirm("로그인 후 이용부탁드립니다. 로그인 페이지로 이동하시겠습니까?")){
                location.href = "/insta/instaLoginPage";
            }
            return;
        }

        console.log("댓글 ID:", commentId); // ID 확인

        const url = "/api/insta/commentLike?comment_id=" + commentId;

        fetch(url)
        .then(response => response.json())
        .then((response) => {

            reloadCommentList(reloadButton);
        })
        ;
    }

    // 댓글 좋아요 유무 확인
    function commentIsLiked(commentId, likeButton, unLikeButton) {
        // const likeButton = document.querySelector("likeButton");
        // const unLikeButton = document.querySelector("unLikeButton");

        if(myInstaId == null) {
            likeButton.classList.add("d-none");
            unLikeButton.classList.remove("d-none");

            return;
        }

        const url = "/api/insta/commentIsLiked?comment_id=" + commentId;
        fetch(url)
        .then(response => response.json())
        .then(response => {

            // const likeButton = document.getElementById("likeButton");
            // const unLikeButton = document.getElementById("unLikeButton");

            if(response.data.confirmCommentLike){ // 좋아요 상태
                likeButton.classList.add("d-none");
                unLikeButton.classList.remove("d-none");

            }else{ // 좋아요 안 눌렀을 때
                unLikeButton.classList.add("d-none");
                likeButton.classList.remove("d-none");
            }
        })
        ;

    }

    // 댓글 좋아요 취소
    function commentUnLike(commentId, reloadButton) {
            if (myInstaId == null) {
                if (confirm("로그인 후 이용 부탁드립니다. 로그인 페이지로 이동하시겠습니까?")) {
                    location.href = "/insta/instaLoginPage";
                }
                return;
            }

            const url = "/api/insta/commentUnLike?comment_id=" + commentId;

            fetch(url)
                .then(response => response.json())
                .then(response => {
                    reloadCommentList(reloadButton); // 상태가 변경된 후 댓글 리스트를 새로고침
                })
                ;
    }

    // 댓글 좋아요 개수 카운트
    function commentLikeCount(commentId, likeCount) {

        const url = "/api/insta/commentLikeCount?comment_id=" + commentId;
        fetch(url)
        .then(response => response.json())
        .then(response => {
            // const likeCount = document.querySelector(".likeCount");
            likeCount.innerText = response.data.likeCount;
        })
        ;

    }


    // 답글 달기 클릭 시 입력 창으로 focus
    function focusOnReplyInput(commentWrapper) {
        const userCommentNickname = commentWrapper.getAttribute('data-userCommentNickname');
        const inputTextReply = document.getElementById("inputText");
        if(inputTextReply) {
            inputTextReply.value = `@${userCommentNickname} `;
            inputTextReply.focus();
        }

        isReply = true; // 대댓글 모드로 전환
        parentCommentId = commentWrapper.getAttribute('data-comment-id'); // 부모 댓글 ID 설정
        console.log("comment ID:", parentCommentId);

    }

    function registerReply(parentCommentId, reloadButton) {

        if(myInstaId == null){
            if(confirm("로그인 하셔야 이용 가능합니다. 로그인 페이지로 이동하시겠습니까?")){
                location.href = "/insta/instaLoginPage";
            }
            return;
        }

        const inputTextReply = document.getElementById("inputText").value.trim();

        const url = "/api/insta/registerReply";

        fetch(url, {
            method: "post",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: `comment_id=${parentCommentId}&reply=${encodeURIComponent(inputTextReply)}`
        })
        .then(response => response.json())
        .then(response => {

            // 서버로 대댓글 데이터 전송
            // 대댓글 등록 후 대댓글 모드 초기화
            isReply = false;
            // parentCommentId = null;
            document.getElementById("inputText").value = ""; // 입력 창 초기화

            // 댓글을 등록한 후, 댓글 목록 갱신
            reloadCommentList(reloadButton);

            // 댓글 목록 갱신 후, 해당 댓글의 답글 목록을 펼치기
            setTimeout(() => {
                const commentWrapper = document.querySelector(`[data-comment-id="${parentCommentId}"]`);
                if(commentWrapper) {
                    const replyToggle = commentWrapper.querySelector('.replyToggle');
                    const replyWrapper = commentWrapper.querySelector(".replyWrapper");
                    if(replyToggle && replyWrapper){
                        replyWrapper.style.display = 'block';
                        replyToggle.querySelector('span').textContent = 'ㅡ 답글 숨기기';
                    }
                }
            }, 300); // reloadCommentList 함수가 끝난 후 실행되도록 약간의 지연을 추가
        });
    }

    // 답글 목록을 숨기거나 보이기
    function toggleReplies(replyWrapper, replyToggle) {
        // 현재 답글이 보이는 상태인지 확인
        const isVisible = replyWrapper.style.display === 'block';

        // replyWrapper의 가시성을 토글
        replyWrapper.style.display = isVisible ? 'none' : 'block';

        // 가시성에 따라 토글 버튼 텍스트 업데이트
        if (isVisible) {
            const replyCount = replyWrapper.querySelectorAll('.replyTemplete').length;
            replyToggle.querySelector('span').textContent = `ㅡ 답글 ${replyCount}개 보기`;
        } else {
            replyToggle.querySelector('span').textContent = 'ㅡ 답글 숨기기';
        }
    }




    // toast
    function showToast() {
        const toast = bootstrap.Toast.getOrCreateInstance(document.getElementById("toast"));
        toast.show();
        setTimeout(() => {
            toast.hide();
        }, 5000);

    }


    // 검색창 포커스 이벤트 리스너
    document.getElementById("searchInput").addEventListener("focus", function() {

        // 전역 변수인 myInstaId에서 값을 가져와서 사용
        const userId = myInstaId;

        window.location.href = `./instaSearchPage?user_id=${userId}`;

    });




    window.addEventListener("DOMContentLoaded", () => {
        // 페이지 로드 후 사실상 시작 지점
        setSessionId();
        setMyInstaId();

    });

</script>

</body>
</html>
