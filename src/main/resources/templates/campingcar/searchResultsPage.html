<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Font Awesome -->
    <script src="https://kit.fontawesome.com/7b271bba58.js" crossorigin="anonymous"></script>
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <link href="/public/css/common.css" rel="stylesheet">
    <link href="/public/css/basecamp.css" rel="stylesheet">
    <script src="/public/js/lockLikeMobile.js"></script>
    <style>
        .carousel-inner img {
            height: 550px;
        }
        .rounded-top-only {
            border-radius: 30px 30px 0 0;
        }
        .location img {
            aspect-ratio: 1/1;
            width: 100px;
            object-fit: cover;
            object-position: center;
        }
        .text-on-image {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            font-size: 11px;
        }
        .btn-block {
            max-width: 100%;
            text-align: left;
            display: inline-block;
        }
        .calendar-container {
            text-align: center;
            font-family: Arial, sans-serif;
            overflow-x: hidden;
        }
        .calendar-container table {
            width: 100%;
            border-collapse: collapse;
            margin: 0 auto;
            border: none;
            table-layout: fixed;
        }
        .calendar-container th, .calendar-container td {
            padding: 0;
            text-align: center;
            border: none;
            height: 40px;
        }
        .calendar-container th {
            color: #999;
            font-weight: bold;
            line-height: 40px;
        }
        .calendar-container td {
            cursor: pointer;
        }
        .calendar-container .inactive {
            color: #ccc;
            pointer-events: none;
        }
        .calendar-container .cursor-pointer .date-circle,
        .calendar-container .cursor-pointer {
            cursor: pointer;
        }
        .calendar-container .selected .date-circle {
            background-color: black;
            color: white;
            border-radius: 50%;
        }
        .calendar-container .today .date-circle {
            border: 2px solid black;
        }
        .calendar-container .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .calendar-container .header button {
            border: none;
            background: none;
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 8px;
        }
        .calendar-container .header button:hover {
            background-color: #f0f0f0;
        }
        .calendar-container .header h4 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .calendar-container .date-circle {
            display: inline-block;
            width: 30px;
            height: 30px;
            line-height: 30px;
            border-radius: 50%;
            text-align: center;
            margin: -2px auto;
        }
        .calendar-container .text-primary {
            color: #007bff;
        }
        
    </style>
</head>
<body>
    <div class="container-fluid fixed-top pt-0 pb-2" style="height: 4.5em;">
        <div class="row h-100">
            <!-- Back Button -->
            <div class="col-auto d-flex align-items-center p-1 pb-4">
                <button class="border-0 bg-transparent d-flex align-items-center text-dark" onclick="history.back();" style="cursor: pointer;">
                    <span class="material-symbols-outlined">arrow_back</span>
                </button>
            </div>

            <!-- Main Content -->
            <div class="col ps-1 pe-0 d-flex align-items-center justify-content-center">
                <div class="w-100">
                    <!-- Location Button -->
                    <div class="d-flex justify-content-between bg-white border border-1 rounded-pill w-100 p-1 mb-1" style="border-color: #28323C;">
                        <div class="d-flex align-items-center">
                            <i class="fa-solid fa-location-dot"></i>
                            <button class="ms-2 new-fs-9 btn bg-white border border-0 p-0" id="locationDisplay" onclick="showLocationModal()">서울</button>
                        </div>
                        <div class="d-flex align-items-center">
                            <i class="fa-solid fa-caravan fa-flip-horizontal"></i>
                            <button class="ms-2 new-fs-9 btn bg-white border border-0 p-0" id="carTypeDisplay" onClick="showCarTypeModal()">모터홈, 차박...</button>
                        </div>
                    </div>

                    <!-- Start Date Button -->
                    <div class="d-flex justify-content-between bg-white border border-1 rounded-pill w-100 p-1" style="border-color: #28323C;">
                        <div class="d-flex align-items-center">
                            <i class="fa-regular fa-calendar"></i>
                            <button class="ps-2 new-fs-9 btn bg-white border border-0 p-0" id="rendDateDisplay" onclick="showRentDateModal()">24.08.27 (화)</button>
                        </div>
                        <div class="d-flex align-items-center">
                            <i class="fa-regular fa-calendar"></i>
                            <button class="ps-2 new-fs-9 btn bg-white border border-0 p-0" id="returnDateDisplay" onclick="showReturnDateModal()">24.08.28 (수)</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filter Icon -->
            <div class="col-auto d-flex align-items-center justify-content-end ps-2 pe-2">
                <div class="bg-white border border-1 rounded-pill d-flex align-items-center justify-content-center" style="width: 2.5em; height: 2.5em; border-color: #28323C;">
                    <button class="position-relative border-0 bg-transparent p-0" onclick="filterOptions()">
                        <span class="material-symbols-outlined new-fs-9">instant_mix</span>
                        <span class="position-absolute" style="top: -8px; right: -9px; width: 0.6em; height: 0.6em; background-color: red; border-radius: 50%;"></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- 대여 장소 선택 모달 -->
        <div class="modal fade" id="locationModal" tabindex="-1" aria-labelledby="locationModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title fs-5 fw-semibold text-center w-100" id="locationModalLabel">대여 장소 선택</div>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="container">
                            <div class="row pb-2">
                                <div class="col-12 d-flex justify-content-center">
                                    <button type="button" class="btn btn-outline-light text-dark w-100" data-location="전체">전체</button>
                                </div>
                            </div>
                            <!-- 대여 지역 리스트 박스 -->
                            <div class="row d-flex flex-wrap" id="regionsListBox"></div>
                        </div>
                    </div>
                    <div class="modal-footer d-flex justify-content-center">
                        <button type="button" class="btn btn-bc-dark w-100" data-bs-dismiss="modal">취소하기</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- 지역선택 모달 Template -->
        <div id="regionsListTemplate" class="d-none">
            <div class="regionstsListWrapper col-6 pb-2 d-flex justify-content-center">
                <span class="regionsBtn btn btn-outline-light text-dark w-100"></span>
            </div>
        </div>
        <!-- 캠핑카 유형 선택 모달 -->
        <div class="modal fade" id="campingcarModal" tabindex="-1" aria-labelledby="campingcarModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title fs-5 fw-semibold text-center w-100" id="campingcarModalLabel">캠핑카 유형 선택</div>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="container">
                            <div class="row" id="carTypeCheckListBox"></div>
                        </div>
                    </div>
                    <div class="modal-footer d-flex justify-content-center">
                        <button type="button" class="carTypeBtn btn btn-bc-dark w-100" data-bs-dismiss="modal" onClick="updateSelectedCarTypes()">선택</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- 캠핑카선택 모달 Template -->
        <div id="carTypeCheckListTemplate" class="d-none">
            <div class="col-12 pb-2">
                <div class="carTypeCheckListWrapper form-check d-flex align-items-center">
                    <input class="carTypeCheck form-check-input" type="checkbox">
                    <label class="form-check-label"></label>
                </div>
            </div>
        </div>
        <!-- 대여일 모달 -->
        <div class="modal fade" id="rentdateModal" tabindex="-1" aria-labelledby="rentdateModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header border-0">
                        <h5 class="modal-title text-center w-100 ps-4" id="rentdateModalLabel">언제 필요한가요?</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="calendar"></div>
                    </div>
                    <div class="modal-footer border-0">
                        <button type="button" class="btn btn-bc-dark w-100" data-bs-dismiss="modal" onclick="confirmRentDate()">확인</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- 반납일 모달 -->
        <div class="modal fade" id="returndateModal" tabindex="-1" aria-labelledby="returndateModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header border-0">
                        <h5 class="modal-title text-center w-100 ps-4" id="returndateModalLabel">반납일 선택</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="calendarReturn"></div>
                    </div>
                    <div class="modal-footer border-0">
                        <button type="button" class="btn btn-bc-dark w-100" data-bs-dismiss="modal" onclick="confirmReturnDate()">확인</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid pt-5 mt-3">
        <div class="row px-3" th:each="searchResultData : ${searchResultList}">
            <a th:href="@{/campingcar/campingCarDetailPage(id=${searchResultData.id})}" class="col px-0 shadow rounded-4 my-4">
                <div class="row mx-0">
                    <div class="col px-0 d-flex justify-content-center align-items-center overflow-hidden rounded-top-4 position-relative">
                        <img th:src="|/images/${searchResultData.main_img}|" class="img-fluid" style="max-width: 100%; min-height: 100%;" alt="썸네일">
                        <div class="position-absolute top-0 end-0 pt-1" style="padding-right: 0.75rem;">
                            <i id="heart-${product_id}" onclick="like()" class="fa-regular fa-heart" style="color: #ff0000;"></i>
                        </div>
                    </div>
                </div>
                <div class="row px-3">
                    <div class="col">
                        <!-- 회사명 + 차량명 -->
                        <div class="row">
                            <div class="col pe-0 pb-2">
                                <span th:text="${searchResultData.comp_name}" class="fw-bold fs-6 text-success"></span>
                                <span th:text="${searchResultData.product_name}" class="fw-bold fs-6" style="color: #484647;"></span>
                            </div>
                        </div>
                        <!-- 비수기 평일가격, 주말가격 -->
                        <div class="row ps-1 d-flex align-items-between">
                            <div class="col-auto fs-6 ps-2 pb-2 d-flex align-items-center">
                                <span class="text-dark fw-semibold pe-1">평일 :</span>
                                <span class="lightFont fw-medium" th:text="${#numbers.formatInteger(searchResultData.rental_fee_weekdays, 3, 'COMMA')}+'원'"></span>
                            </div>
                            <div class="col-2 px-0"></div>
                            <div class="col-auto fs-6 px-0 pb-2 d-flex justify-content-center align-items-center">
                                <span class="text-dark fw-semibold pe-1">주말 :</span>
                                <span class="lightFont fw-medium" th:text="${#numbers.formatInteger(searchResultData.rental_fee_weekend, 3, 'COMMA')}+'원'"></span>
                            </div>
                        </div>
                        <!-- 차고지 주소 + 운전 조건 -->
                        <div class="row border-top d-flex-items-between">
                            <div class="col-12 pt-2 pb-2 fw-bold new-fs-8" style="color: #7C7B7B;">
                                <div class="d-flex align-items-center">
                                    <div th:text="'차고지 : ' + ${searchResultData.garage_address}"></div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12 pb-2 pe-0 fw-bold new-fs-8" style="color: #7C7B7B;">
                                <div class="d-flex align-items-center flex-wrap gap-2">
                                    <div th:text="'운전면허증 : ' + ${searchResultData.driver_license_condition_name} + ' |'"></div>
                                    <div th:text="'운전자 나이 : ' + ${searchResultData.driver_age_condition_name} + ' |'"></div>
                                    <div th:text="'운전자 경력 : ' + ${searchResultData.driver_experience_condition_name}"></div>
                                </div>
                            </div>
                        </div>
                        <!-- 동승, 취침, 애완 조건 -->
                        <div class="row py-2 new-fs-7 border-top">
                            <div class="col px-2 d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <span class="material-symbols-outlined pe-1 fs-5">groups</span>
                                    <span class="text-center pe-2" th:text="'동승 인원 ' + ${searchResultData.seating_capacity} + '명'"></span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <span class="material-symbols-outlined pe-1 fs-5">hotel</span>
                                    <span class="text-center pe-0" th:text="'취침 인원 ' + ${searchResultData.sleeping_capacity} + '명'"></span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <span class="material-symbols-outlined ps-2 new-fs-9">Pets</span>
                                    <span class="text-center pe-0" th:text="' 반려 동물  ' + ${searchResultData.pet_friendly}"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </a>
        </div>
    </div>
    <!-- 모든 리스트가 출력된 후에 메시지를 출력 -->
    <div class="container">
        <div class="row text-center pb-4">
            <div class="col">
                <span class="text-body-tertiary">모든 내용을 불러왔습니다.</span>
            </div>
        </div>
    </div>    

    <!-- footer -->
    <div th:replace="~{campingcar/campingNavi::footerNavi}"></div>
    <!-- bottom -->
    <div th:replace="~{campingcar/campingNavi::bottomNaviBasecamp}"></div>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const urlParams = new URLSearchParams(window.location.search);

            // 필터링 값을 가져오기
            const location = urlParams.get('location');
            const carTypes = urlParams.get('carTypes') ? urlParams.get('carTypes').split(',') : [];
            const rentDate = urlParams.get('rentDate');
            const returnDate = urlParams.get('returnDate');

            // UI에 필터링 값 반영
            if (location) {
                document.getElementById("locationDisplay").innerText = location;
            }
            if (carTypes.length > 0) {
                document.getElementById("carTypeDisplay").innerText = carTypes.join(', ');
            }
            if (rentDate) {
                document.getElementById("rendDateDisplay").innerText = rentDate;
            }
            if (returnDate) {
                document.getElementById("returnDateDisplay").innerText = returnDate;
            }
        });

        const today = new Date();
        let currentMonth = today.getMonth();
        let currentYear = today.getFullYear();
        let lastSelectedDate = null;
        let lastSelectedReturnDate = null;

        document.addEventListener("DOMContentLoaded", () => {
            renderCalendar(currentMonth, currentYear);
            renderReturnCalendar(currentMonth, currentYear);
        });

        // 대여 장소 선택 모달 열기 함수 
        const showLocationModal = () => {
            const locationModal = new bootstrap.Modal(document.getElementById("locationModal"));
            loadRegionOptionList(); 
            locationModal.show();
        }

        function loadRegionOptionList() {
            fetch("/api/rent-user/getRegionsAll")
            .then(response => response.json())
            .then(response => {
                const regionsListBox = document.getElementById("regionsListBox");
                regionsListBox.innerHTML = "";  // 컨테이너의 기존 내용을 초기화

                const template = document.querySelector("#regionsListTemplate .regionstsListWrapper"); 

                response.data.allRegionsList.forEach(region => {
                    const newRegion = template.cloneNode(true);
                    const newButton = newRegion.querySelector(".regionsBtn"); 
                    newButton.innerText = region.name;

                    newButton.addEventListener('click', () => {
                        document.getElementById("locationDisplay").innerText = region.name;
                        const modalInstance = bootstrap.Modal.getInstance(document.getElementById("locationModal"));
                        modalInstance.hide();
                    });

                    regionsListBox.appendChild(newRegion);
                });
            });
        }

        let selectedCarTypes = [];

        // 캠핑카 유형 선택 모달 열기 함수 
        const showCarTypeModal = () => {
            const campingcarModal = new bootstrap.Modal(document.getElementById("campingcarModal")); 
            loadCampingCarTypeOptionList();
            campingcarModal.show();
        }

        function loadCampingCarTypeOptionList() {
            fetch("/api/rent-user/getCarTypeAll")
            .then(response => response.json())
            .then(response => {
                const carTypeCheckListBox = document.getElementById("carTypeCheckListBox");
                carTypeCheckListBox.innerHTML = "";  // 컨테이너의 기존 내용을 초기화

                const template = document.querySelector("#carTypeCheckListTemplate .carTypeCheckListWrapper"); 

                response.data.allCarType.forEach((carType, index) => {
                    const newCarType = template.cloneNode(true);
                    const checkbox = newCarType.querySelector(".carTypeCheck");
                    const label = newCarType.querySelector(".form-check-label");

                    checkbox.value = carType.name; 
                    checkbox.id = `carTypeCheck${index}`;
                    label.innerText = carType.name;
                    label.setAttribute("for", `carTypeCheck${index}`);

                    checkbox.addEventListener('change', (event) => selectCarType(event));
                    carTypeCheckListBox.appendChild(newCarType);
                });
            });
        }

        function selectCarType(event) { 
            const { value, checked } = event.target;
            if (checked) {
                selectedCarTypes.push(value);
            } else {
                selectedCarTypes = selectedCarTypes.filter(type => type !== value);
            }
        }

        function updateSelectedCarTypes() {
            document.getElementById("carTypeDisplay").innerText = selectedCarTypes.join(', ');
        }

        // 대여일 모달 열기 함수 
        const showRentDateModal = () => {
            const rentDateModal = new bootstrap.Modal(document.getElementById("rentdateModal"));
            rentDateModal.show();
            renderCalendar(currentMonth, currentYear);
        }

        // 반납일 모달 열기 함수 
        const showReturnDateModal = () => {
            const returnDateModal = new bootstrap.Modal(document.getElementById("returndateModal"));
            returnDateModal.show();
            renderReturnCalendar(currentMonth, currentYear);
        }

        function renderCalendar(month, year) {
            renderCalendarTemplate("calendar", month, year, lastSelectedDate, selectDate);
        }

        function renderReturnCalendar(month, year) {
            renderCalendarTemplate("calendarReturn", month, year, lastSelectedReturnDate, selectReturnDate);
        }

        function renderCalendarTemplate(calendarId, month, year, lastSelectedDate, selectDateFunction) {
            const firstDay = new Date(Date.UTC(year, month, 1)).getUTCDay();
            const lastDate = new Date(Date.UTC(year, month + 1, 0)).getUTCDate();
            const lastDatePrevMonth = new Date(Date.UTC(year, month, 0)).getUTCDate();
            const calendar = document.getElementById(calendarId);

            let html = `
                <div class="calendar-container">
                    <div class="header">
                        <button class="btn btn-light" onclick="changeMonth(${calendarId}, -1)">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <h4>${year}.${month + 1 < 10 ? '0' : ''}${month + 1}</h4>
                        <button class="btn btn-light" onclick="changeMonth(${calendarId}, 1)">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th class="text-danger">일</th>
                                <th>월</th>
                                <th>화</th>
                                <th>수</th>
                                <th>목</th>
                                <th>금</th>
                                <th class="text-primary">토</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            let date = 1;
            let nextMonthDate = 1;

            for (let i = 0; i < 6; i++) {
                html += '<tr>';
                for (let j = 0; j < 7; j++) {
                    if (i === 0 && j < firstDay) {
                        html += `<td class="inactive">${lastDatePrevMonth - firstDay + 1 + j}</td>`;
                    } else if (date > lastDate) {
                        html += `<td class="inactive">${nextMonthDate++}</td>`;
                    } else {
                        let cellDate = new Date(Date.UTC(year, month, date));
                        let cellClass = cellDate < today && !(date === today.getUTCDate() && month === today.getUTCMonth() && year === today.getUTCFullYear()) ? 'inactive' : 'cursor-pointer';
                        if (date === today.getUTCDate() && month === today.getUTCMonth() && year === today.getUTCFullYear() && !lastSelectedDate) {
                            cellClass += ' today';
                        }
                        html += `<td class="${cellClass}" data-date="${cellDate.toISOString().split('T')[0]}" onclick="${selectDateFunction.name}(this, '${cellDate.toISOString().split('T')[0]}')"><span class="date-circle">${date++}</span></td>`;
                    }
                }
                html += '</tr>';
            }

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            calendar.innerHTML = html;

            if (lastSelectedDate) {
                const selectedCell = calendar.querySelector(`[data-date="${lastSelectedDate}"]`);
                if (selectedCell) {
                    selectedCell.classList.add('selected');
                }
            }
        }

        function changeMonth(calendarId, direction) {
            currentMonth += direction;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendarTemplate(calendarId, currentMonth, currentYear);
        }

        function selectDate(cell, date) {
            document.querySelectorAll('#calendarBody td').forEach(td => td.classList.remove('selected', 'today'));
            cell.classList.add('selected');
            lastSelectedDate = date;
        }

        function selectReturnDate(cell, date) {
            document.querySelectorAll('#calendarBodyReturn td').forEach(td => td.classList.remove('selected', 'today'));
            cell.classList.add('selected');
            lastSelectedReturnDate = date;
        }

        function confirmRentDate() {
            const selectedDate = document.querySelector('#calendarBody td.selected').dataset.date;
            if (selectedDate) {
                const displayDate = new Date(selectedDate);
                document.getElementById("rendDateDisplay").textContent = displayDate.toISOString().split('T')[0];
            }
        }

        function confirmReturnDate() {
            const selectedReturnDate = document.querySelector('#calendarBodyReturn td.selected').dataset.date;
            if (selectedReturnDate) {
                const displayDate = new Date(selectedReturnDate);
                document.getElementById("returnDateDisplay").textContent = displayDate.toISOString().split('T')[0];
            }
        }
    </script>
</body>
</html>
