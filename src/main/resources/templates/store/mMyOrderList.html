<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://kit.fontawesome.com/7b271bba58.js" crossorigin="anonymous"></script>

    <script src="/public/js/lockLikeMobile.js"></script>

    <link rel="stylesheet" href="/public/css/font.css">
    <link rel="stylesheet" href="/public/css/basecamp.css">

    <title>BASECAMP</title>

    <style>
        .fill-on {
            font-variation-settings: 'FILL' 1;
        }
        .fill-off {
            font-variation-settings: 'FILL' 0;
        }
        .seller_profile img{
            aspect-ratio: 1/1;
            width: 100px;
            object-fit: cover;
            object-position: center;
        }
        .icon-col img{
            aspect-ratio: 1/1;
            width: 100%;
            object-fit: cover;
            object-position: center;
        }
        .product-col img{
            aspect-ratio: 1/1;
            width: 100%;
            object-fit: cover;
            object-position: center;
        }
        a{
            text-decoration: none;
            color: black;
        }
        button{
            color: black;
        }
        .f05{
            font-size: 0.5em;
        }
        .f08{
            font-size: 0.8em;
        }
        .f09{
            font-size: 0.9em;
        }
        .f12{
            font-size: 1.2em;
        }
        .f17{
            font-size: 1.7em;
        }
        .f20{
            font-size: 2em;
        }
        .f40{
            font-size: 4em;
        }
        .active{
            font-weight: bold;
            border-bottom: 2px solid black;
        }
    </style>
</head>
<body class="bg-light">

    <!-- top-nav -->
    <div class="container">
        <div class="fixed-top px-4 row border-bottom bg-white">
            <div class="col">
                <div class="row py-3 align-items-center">
                    <div class="col-auto ps-0">
                        <button id="backButton" class="border-0 bg-transparent d-flex align-items-center">
                            <span class="material-symbols-outlined">
                                arrow_back_ios
                            </span>
                        </button>
                    </div>
                    <div class="col ps-0 fw-bold f12 text-center">
                        주문/배송조회
                    </div>
                    <a href="/" class="col-auto pe-0 d-flex align-items-center text-black">
                        <span class="material-symbols-outlined">
                            home
                        </span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container" style="padding-top: 60.792px;">

        <div class="row">
            <div class="col">

                <div class="row border-bottom mb-3">
                    <div class="col text-center p-0">
                        <img src="/public/img/storeImage/myOrderListBanner.jpg" style="width: 100%;">
                    </div>
                </div>

                <div class="row bg-white py-3 align-items-center border-top border-bottom">
                    <div class="col-auto pe-0">
                        <span class="fw-bold">전체</span>
                    </div>
                    <div class="col">
                        <span class="f08">최근 1년</span>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-sm border rounded-pill d-flex align-items-center">
                            <span>필터</span>
                            <span class="material-symbols-outlined f12">
                                tune
                            </span>
                        </button>
                    </div>
                </div>

                <!-- 필터선택 -->
                <div class="row bg-white py-3 mb-3 border-bottom">
                    <div class="col d-grid">
                        <a type="button" class="row text-dark p-0 text-center border-0 bg-transparent">
                            <div onclick="reloadOrderList(this)" class="col orderProductStatusFilter text-primary">
                                <div class="row pb-2 fw-bold fs-4">
                                    <div class="col" id="allOrderCount">0</div>
                                </div>
                                <div class="row f08">
                                    <div class="col px-1 filterOption">전체</div>
                                </div>                                    
                            </div>
                        </a>
                    </div>
                    <div class="col d-grid">
                        <button type="button" class="row text-secondary p-0 text-center border-0 bg-transparent">
                            <div onclick="reloadOrderList(this)" class="col orderProductStatusFilter">
                                <div class="row pb-2 fw-bold fs-4">
                                    <div class="col" id="orderCompleteCount">0</div>
                                </div>
                                <div class="row f08">
                                    <div class="col px-1 filterOption">주문완료</div>
                                </div>                                    
                            </div>
                        </button>
                    </div>
                    <div class="col d-grid">
                        <button type="button" class="row text-secondary p-0 text-center border-0 bg-transparent">
                            <div onclick="reloadOrderList(this)" class="col orderProductStatusFilter">
                                <div class="row pb-2 fw-bold fs-4">
                                    <div class="col">0</div>
                                </div>
                                <div class="row f08">
                                    <div class="col px-1 filterOption">배송중</div>
                                </div>                                    
                            </div>
                        </button>
                    </div>
                    <div class="col d-grid">
                        <button type="button" class="row text-secondary p-0 text-center border-0 bg-transparent">
                            <div onclick="reloadOrderList(this)" class="col orderProductStatusFilter">
                                <div class="row pb-2 fw-bold fs-4">
                                    <div class="col" id="deliveryCompleteCount">0</div>
                                </div>
                                <div class="row f08">
                                    <div class="col px-1 filterOption">배송완료</div>
                                </div>                                    
                            </div>
                        </button>
                    </div>
                    <div class="col d-grid">
                        <button type="button" class="row text-dark p-0 text-center border-0 bg-transparent">
                            <div onclick="reloadOrderList(this)" class="col orderProductStatusFilter">
                                <div class="row pb-2 fw-bold fs-4">
                                    <div class="col" id="purchaseConfirmationCount">0</div>
                                </div>
                                <div class="row f08">
                                    <div class="col px-1 filterOption">구매확정</div>
                                </div>                                    
                            </div>
                        </button>
                    </div>
                </div>

                <div class="row">
                    <div class="col" id="orderContainer">

                    </div>
                </div>
                
            </div>
        </div>
        
        <!-- footer -->
        <div class="row py-2 bg-dark-subtle text-white text-center f09">
            <div class="col fw-bold border-end">
                로그아웃
            </div>
            <div class="col fw-bold border-end">
                고객센터
            </div>
            <div class="col fw-bold">
                NEWS
            </div>
        </div>
        <div class="row py-4 px-3 bg-body-secondary text-secondary">
            <div class="col">
                <div class="row pb-2">
                    <div class="col-auto p-0">
                        <span class="material-symbols-outlined f20">
                            camping
                        </span>
                    </div>
                    <div class="col p-0 fw-bold fs-3">
                        <span>&nbsp;BASECAMP</span>
                    </div>
                </div>
                <div class="row pb-3 border-bottom border-2">
                    <div class="col p-0 f08">
                        BASECAMP는 통신판매 중개자로서 통신판매의 당사자가 아니며 상품의 예약, 이용 및 환불 등과 관련한 의무와 책임은 각 판매자에게 있습니다.
                    </div>
                </div>

                <div class="row pt-3 py-3 border-bottom border-2">
                    <div class="col-auto p-0">
                        <button class="btn btn-sm bg-dark-subtle text-white fw-bold f08 d-flex align-items-center">
                            <span class="material-symbols-outlined f12">
                                phone_in_talk
                            </span>
                            <span>&nbsp;고객센터</span>
                        </button>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-sm bg-dark-subtle text-white fw-bold f08">
                            카카오 1:1 문의
                        </button>
                    </div>
                    <div class="col p-0 f08">
                        <div class="row">
                            <div class="col">
                                <span>평일</span> : 10:00 ~ 17:00
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <span>점심</span> : 12:00 ~ 13:00
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                * 주말 공휴일 휴무
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row pt-3 align-items-center">
                    <div class="col-auto me-2 bg-dark-subtle rounded-circle d-flex align-items-center" style="aspect-ratio: 1/1;">
                        <i class="bi bi-google-play"></i>
                    </div>
                    <div class="col-auto me-2 bg-dark-subtle rounded-circle d-flex align-items-center" style="aspect-ratio: 1/1;">
                        <i class="bi bi-youtube"></i>
                    </div>
                    <div class="col-auto me-2 bg-dark-subtle rounded-circle d-flex align-items-center" style="aspect-ratio: 1/1;">
                        <i class="bi bi-instagram"></i>
                    </div>
                    <div class="col-auto pe-0 f08">
                        이용약관
                    </div>
                    <div class="col f08">
                        개인정보처리방침
                    </div>
                </div>
                <div class="row py-5"></div>
                <div class="row py-4"></div>
            </div>
        </div>

    </div>

    <!--구매 하단네비 -->
    <div th:fragment="bottomNaviBasecamp" class="container-fluid g-0 border-top bg-white fixed-bottom pb-3">
        <div class="row mx-1 py-2 text-center">
            
            <!--HOME-->
            <a href="/" class="col icon-and-text">
                <span class="material-symbols-outlined fw-light" style="font-size: 1.8em; color: darkgray;">
                    home
                </span>
                <span class="text-navi pt-1" style="font-size: 0.7em; color: darkgray">홈</span>
            </a>        

            <!--구매-->
            <div class="col icon-and-text dropdown dropup">
                <span data-bs-toggle="dropdown" class="material-symbols-outlined" style="font-size: 1.7em;">
                    storefront
                </span>
                <span class="text-navi pt-1 fw-bold" style="font-size: 0.7em;">구매</span>
                <ul class="dropdown-menu custom-dropdown-menu">
                    <!-- 변초연 -->
                    <a class="dropdown-item col" href="/store">
                        <div class="row w-100">
                            <div class="col-auto d-flex">
                                <span class="material-symbols-outlined pe-1 ps-1 fw-light">
                                    shopping_bag
                                </span>
                                <span style="font-size: 0.9em;">스토어</span>
                            </div>
                        </div>
                    </a>
                    <!-- 심규진 -->
                    <a class="dropdown-item col" href="/secondhandProduct/mainPage">
                        <div class="row w-100">
                            <div class="col-auto d-flex">
                                <span class="material-symbols-outlined pe-1 ps-1 fw-light">
                                    eco
                                </span>
                                <span style="font-size: 0.9em;">중고</span>
                            </div>
                        </div>
                    </a>
                </ul>
            </div>

            <!--예약-->
            <div class="col icon-and-text dropdown dropup">
                <span data-bs-toggle="dropdown" class="material-symbols-outlined fw-light" style="font-size: 1.7em; color: darkgray">
                    event_available
                </span>
                <span class="text-navi pt-1" style="font-size: 0.7em; color: darkgray">예약</span>
                <ul class="dropdown-menu row custom-dropdown-menu">
                    <!-- 조준희 -->
                    <a class="dropdown-item col" href="/camp/main">
                        <div class="row w-100">
                            <div class="col-auto d-flex">
                                <span class="material-symbols-outlined pe-1 ps-1 fw-light">
                                    camping
                                </span>
                                <span style="font-size: 0.9em;">캠핑장</span>
                            </div>
                        </div>
                    </a>
                    <!-- 양은자 -->
                    <a class="dropdown-item col" href="/campingcar/main">
                        <div class="row w-100">
                            <div class="col-auto d-flex">
                                <span class="material-symbols-outlined pe-1 ps-1 fw-light">
                                    airport_shuttle
                                </span>
                                <span style="font-size: 0.9em;">캠핑카</span>
                            </div>
                        </div>
                    </a>
                </ul>
            </div>

            <!--커뮤-->
            <div class="col icon-and-text dropdown dropup">
                <span data-bs-toggle="dropdown" class="material-symbols-outlined fw-light" style="font-size: 1.7em; color: darkgray">
                    forum
                </span>
                <span class="text-navi pt-1" style="font-size: 0.7em; color: darkgray">커뮤니티</span>
                <ul class="dropdown-menu custom-dropdown-menu">
                    <!-- 이시은 -->
                    <a class="dropdown-item col" href="/club/main">
                        <div class="row w-100">
                            <div class="col-auto d-flex">
                                <span class="material-symbols-outlined pe-1 ps-1 fw-light">
                                    group
                                </span>
                                <span style="font-size: 0.9em;">소모임</span>
                            </div>
                        </div>
                    </a>
                    <!-- 남현지 -->
                    <a class="dropdown-item col" href="/insta/instaMainPage">
                        <span>
                            <img src="/public/img/instaImage/campstagram.png" class="img-fluid">
                        </span>
                    </a>
                </ul>
            </div>

            <!--내정보-->
            <a class="col icon-and-text" href="/user/login" th:if="${session.sessionUserInfo == null}">
                <span class="material-symbols-outlined pe-1 ps-1 fw-light"style="font-size: 1.7em; color: darkgray;">
                    person
                </span>
                <span class="text-navi pt-1" style="font-size: 0.7em; color: darkgray;">마이</span>
            </a>
            <a class="col icon-and-text" href="/user/myPage" th:unless="${session.sessionUserInfo == null}">
                <span class="material-symbols-outlined pe-1 ps-1 fw-light"style="font-size: 1.7em; color: darkgray;">
                    person
                </span>
                <span class="text-navi pt-1" style="font-size: 0.7em; color: darkgray;">마이</span>
            </a>
        </div>
    </div>

    <div id="template" class="d-none">
        <!-- 주문 하나의 정보 -->
        <div class="row orderTemplate mb-3 border-top border-bottom">
            <div class="col">

                <!-- 주문상세보기 -->
                <a href="/store/orderView" class="row bg-white py-2 border-bottom orderView">
                    <div class="col fw-bold orderDate">
                        2024.07.07
                    </div>
                    <div class="col-auto d-flex align-items-center">
                        <span class="material-symbols-outlined">
                            chevron_forward
                        </span>
                    </div>
                </a>

                <div class="row">
                    <div class="col orderProductContainer">
                        
                    </div>
                </div>
                
            </div>
        </div>

        <!-- 상품 하나의 정보 -->
        <div class="row orderProductTemplate bg-white">
            <div class="col orderProductCol">
                <div class="row py-3">
                    <div class="col fw-bold f09 status">
                        구매확정
                    </div>
                </div>
                <div class="row">
                    <div class="col-auto pe-0 seller_profile">
                        <img class="border productImg" src="https://www.cat-lab.co.kr/data/editor/1811/ebb93bf998cab0e92df4402e266c4e50_1541192645_5868.jpg">
                    </div>
                    <div class="col">
                        <div class="row pb-1">
                            <div class="col f09 storeName">
                                GamjaStore
                            </div>
                        </div>
                        <div class="row pb-1">
                            <a class="col-auto f09 fw-bold name">
                                진짜 맛있는 납작복숭아
                            </a>
                        </div>
                        <div class="row pb-1 text-body-tertiary f09">
                            <div class="col-auto pe-0 valueName d-none">
                                Black / M
                            </div>
                            <div class="col">
                                <span class="quantity">5개</span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col fw-bold price">
                                13,500원
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div class="row py-3 buttonsForPurchaseConfirmation">
            <div class="col d-grid">
                <a class="btn reviewButton border py-2 bg-white rounded-0 f09">
                    리뷰작성
                </a>
            </div>
        </div>

        <div class="row py-3 buttonsForReviewComplete">
            <div class="col d-grid">
                <a href="/store/myReview" class="btn border py-2 bg-white rounded-0 f09">
                    작성한 리뷰 보기
                </a>
            </div>
        </div>
        
        <div class="row py-3 buttonsForOrderComplete">
            <div class="col d-grid pe-0">
                <button class="btn border py-2 bg-white rounded-0 f09">
                    주문취소
                </button>
            </div>
            <div class="col d-grid">
                <button class="btn border py-2 bg-white rounded-0 f09">
                    배송지 변경
                </button>
            </div>
        </div>

        <div class="row py-3 buttonsForDelivered">
            <div class="col d-grid pe-0">
                <a type="button" class="requestRefundButton btn border py-2 bg-white rounded-0 f09">
                    환불요청
                </a>
            </div>
            <div class="col d-grid">
                <a type="button" class="purchaseConfirmationButton btn border py-2 bg-white rounded-0 f09">
                    구매확정
                </a>
            </div>
        </div>
        <div class="row py-3 buttonsForRefundComplete">
            <div class="col d-grid">
                <a type="button" class="btn border py-2 bg-white rounded-0 f09">
                    환불상세
                </a>
            </div>
        </div>

    </div>

    <script>
        let filterOption = "전체"

        function formatNumberToPrice(number) {
            return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('backButton').addEventListener('click', function() {
                history.back();
            });
            reloadOrderList("전체");
            getOrderStatusCount();
        });

        function getOrderStatusCount(){
            const url = "/api/store/getOrderStatusCount"
            fetch(url)
            .then(response => response.json())
            .then(response => {
                const orderStatusCount = response.data.orderStatusCount
                document.getElementById("allOrderCount").innerText = orderStatusCount.allOrderCount;
                document.getElementById("orderCompleteCount").innerText = orderStatusCount.orderCompleteCount;
                document.getElementById("deliveryCompleteCount").innerText = orderStatusCount.deliveryCompleteCount;
                document.getElementById("purchaseConfirmationCount").innerText = orderStatusCount.purchaseConfirmationCount + orderStatusCount.reviewCompleteCount;
            })
        }

        function reloadOrderList(selectedStatusFilter){

            if(selectedStatusFilter == "전체"){
                filterOption = '전체'
            }else{
                const statusFilters = document.querySelectorAll(".orderProductStatusFilter")
                statusFilters.forEach(statusFilter => statusFilter.classList.remove("text-primary"))

                selectedStatusFilter.classList.add("text-primary")
                filterOption = selectedStatusFilter.querySelector(".filterOption").innerText;
            }
            
            const url = `/api/store/getOrderDataList?filterOption=${filterOption}`
            fetch(url)
            .then(response => response.json())
            .then(response => {
                
                const orderDataList = response.data.orderDataList;

                const orderContainer = document.getElementById("orderContainer");
                orderContainer.innerHTML = "";

                const orderTemplate = document.querySelector("#template .orderTemplate");
                
                for(orderData of orderDataList){

                    if(orderData.OrderProductDataList.length==0||orderData.storeOrderDto.status=='pending'){
                        continue;
                    }

                    const newOrderTemplate = orderTemplate.cloneNode(true);

                    const orderDate = newOrderTemplate.querySelector(".orderDate");
                    const date = new Date(orderData.storeOrderDto.created_at);
                    orderDate.innerText = `${date.getFullYear()}.${date.getMonth()+1}.${date.getDate()}`;

                    newOrderTemplate.querySelector(".orderView").setAttribute("href", `/store/orderView?id=${orderData.storeOrderDto.id}`)

                    const orderProductContainer = newOrderTemplate.querySelector(".orderProductContainer");
                    const orderProductTemplate = document.querySelector("#template .orderProductTemplate");

                    for(OrderProductData of orderData.OrderProductDataList){

                        if(OrderProductData.orderProductDto.status=='pending'){
                            continue;
                        }

                        const newOrderProductTemplate = orderProductTemplate.cloneNode(true);
                        const status = OrderProductData.orderProductDto.status;
                        newOrderProductTemplate.querySelector(".status").innerText = status;
                        newOrderProductTemplate.querySelector(".storeName").innerText = OrderProductData.store_name;
                        
                        const productName = newOrderProductTemplate.querySelector(".name")
                        productName.innerText = OrderProductData.orderProductDto.product_name;
                        productName.setAttribute("href", `/store/productDetails?id=${OrderProductData.orderProductDto.product_id}`)

                        if(OrderProductData.valueNameList.length!=0){
                            const valueName = newOrderProductTemplate.querySelector(".valueName")
                            valueName.innerText = `${OrderProductData.valueNameList.join("/")} |`;
                            valueName.classList.remove("d-none");
                        }
                        newOrderProductTemplate.querySelector(".productImg").setAttribute("src", `/images/${OrderProductData.orderProductDto.product_main_image}`)

                        newOrderProductTemplate.querySelector(".quantity").innerText = `${OrderProductData.orderProductDto.quantity}개`;
                        newOrderProductTemplate.querySelector(".price").innerText = `${formatNumberToPrice(OrderProductData.orderProductDto.order_price)}원`

                        const orderProductCol = newOrderProductTemplate.querySelector(".orderProductCol");

                        newOrderProductTemplate.setAttribute("id", OrderProductData.orderProductDto.id);

                        if(status=='배송완료'){
                            const buttonsForDelivered = document.querySelector("#template .buttonsForDelivered").cloneNode(true);
                            buttonsForDelivered.querySelector(".requestRefundButton").setAttribute("href", `/store/orderRefund?id=${OrderProductData.orderProductDto.id}`)
                            buttonsForDelivered.querySelector(".purchaseConfirmationButton").setAttribute("onclick", `purchaseConfirmation(${OrderProductData.orderProductDto.id})`)
                            orderProductCol.appendChild(buttonsForDelivered)
                        }else if(status=='주문완료'){
                            const buttonsForOrderComplete = document.querySelector("#template .buttonsForOrderComplete").cloneNode(true);
                            orderProductCol.appendChild(buttonsForOrderComplete)
                        }else if(status=='상품준비중'){
                            const buttonsForOrderComplete = document.querySelector("#template .buttonsForOrderComplete").cloneNode(true);
                            orderProductCol.appendChild(buttonsForOrderComplete)
                        }else if(status=='구매확정'){
                            const buttonsForPurchaseConfirmation = document.querySelector("#template .buttonsForPurchaseConfirmation").cloneNode(true);
                            buttonsForPurchaseConfirmation.querySelector(".reviewButton").setAttribute("href", `/store/writeReview?id=${OrderProductData.orderProductDto.id}`)
                            orderProductCol.appendChild(buttonsForPurchaseConfirmation)
                        }else if(status=='리뷰작성완료'){
                            const buttonsForReviewComplete = document.querySelector("#template .buttonsForReviewComplete").cloneNode(true);
                            orderProductCol.appendChild(buttonsForReviewComplete);
                        }else if(status=='환불완료'){
                            const buttonsForRefundComplete = document.querySelector("#template .buttonsForRefundComplete").cloneNode(true);
                            orderProductCol.appendChild(buttonsForRefundComplete);
                        }

                        orderProductContainer.appendChild(newOrderProductTemplate);
                    }
                    
                    orderContainer.appendChild(newOrderTemplate);
                }
            })
        }

        function purchaseConfirmation(order_product_id){
            if(confirm("구매 확정 하시겠습니까? (구매 확정 처리 이후 교환/환불이 어렵습니다.)")){
                const url = `/api/store/purchaseConfirmation?id=${order_product_id}`
                fetch(url)
                .then(response => {
                    const orderProductTemplate = document.getElementById(order_product_id);
                    const buttonsForDelivered = orderProductTemplate.querySelector(".buttonsForDelivered");
                    buttonsForDelivered.parentNode.removeChild(buttonsForDelivered)

                    const orderProductCol = orderProductTemplate.querySelector(".orderProductCol");
                    const buttonsForPurchaseConfirmation = document.querySelector("#template .buttonsForPurchaseConfirmation").cloneNode(true);
                    buttonsForPurchaseConfirmation.querySelector(".reviewButton").setAttribute("href", `/store/writeReview?id=${OrderProductData.orderProductDto.id}`)
                    orderProductCol.appendChild(buttonsForPurchaseConfirmation);
                    
                    getOrderStatusCount();
                })
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>