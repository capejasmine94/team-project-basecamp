<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://kit.fontawesome.com/7b271bba58.js" crossorigin="anonymous"></script>

    <script src="/public/js/lockLikeMobile.js"></script>

    <link rel="stylesheet" href="/public/css/font.css">

    <title>BASECAMP</title>

    <style>
        .fill-on {
            font-variation-settings: 'FILL' 1;
        }
        .fill-off {
            font-variation-settings: 'FILL' 0;
        }
        .seller_profile img{
            aspect-ratio: 1/1;
            width: 60px;
            object-fit: cover;
            object-position: center;
        }
        .icon-col img{
            aspect-ratio: 1/1;
            width: 100%;
            object-fit: cover;
            object-position: center;
        }
        .product-col img{
            aspect-ratio: 1/1;
            width: 100%;
            object-fit: cover;
            object-position: center;
        }
        a{
            text-decoration: none;
            color: black;
        }
        button{
            color: black;
        }
        .f05{
            font-size: 0.5em;
        }
        .f08{
            font-size: 0.8em;
        }
        .f09{
            font-size: 0.9em;
        }
        .f12{
            font-size: 1.2em;
        }
        .f17{
            font-size: 1.7em;
        }
        .f20{
            font-size: 2em;
        }
        .f40{
            font-size: 4em;
        }
        .active{
            font-weight: bold;
            border-bottom: 2px solid black;
        }
        #reviewTextarea:focus{
            outline: none;
        }
        #reviewTextarea::placeholder{
            font-size: 0.8em;
            color: rgb(159, 159, 159);
        }
        #agreeTermsButton:focus{
            outline: none;
        }
        li::marker {
            font-size: 8px;
        }
        .ratingCol{
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-white">

    <!-- top-nav -->
    <div class="container">
        <div class="fixed-top px-4 row border-bottom bg-white">
            <div class="col">
                <div class="row py-3 align-items-center">
                    <div class="col-auto ps-0">
                        <button id="backButton" class="border-0 bg-transparent d-flex align-items-center">
                            <span class="material-symbols-outlined">
                                arrow_back_ios
                            </span>
                        </button>
                    </div>
                    <div class="col ps-0 fw-bold f12 text-center">
                        리뷰
                    </div>
                    <a href="/store/cart" class="col-auto pe-0 d-flex align-items-center text-black">
                        <span class="material-symbols-outlined">
                            shopping_bag
                        </span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container" style="padding-top: 60.792px;">

        <div class="row">
            <div class="col">

                <!-- 주문 상품 정보 -->
                <div class="row px-3 py-3 border-bottom">
                    <div class="col-auto p-0 seller_profile">
                        <img th:src="|/images/${orderProductData.product_main_image}|">
                    </div>
                    <div class="col f08">
                        <div class="row">
                            <div class="col">
                                <span th:text="${orderProductData.store_name}">oar</span>
                            </div>
                        </div>
                        <div class="row fw-semibold">
                            <div class="col">
                                <span th:text="${orderProductData.product_name}">oar Vintage Shirt Scrunchie [White]</span>
                            </div>
                        </div>
                        <div class="row text-body-tertiary">
                            <div class="col">
                                <span th:if="${orderProductData.valueNameList}!=null" th:each="name, iterStat : ${orderProductData.valueNameList}">
                                    <span th:text="${name}">white</span>
                                    <span th:if="${!iterStat.last}">/</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 별점 -->
                <div class="row py-5 border-bottom">
                    <div class="col">
                        <div class="row text-center fw-semibold">
                            <div class="col">
                                상품은 마음에 드셨나요?
                            </div>
                        </div>
                        <div class="row text-center pt-2">
                            <div class="col ratingCol">
                                <span id="1" class="material-symbols-outlined fill-on fw-light f20 text-dark rating" onclick="rating(this)">
                                    star
                                </span>
                                <span id="2" class="material-symbols-outlined fill-on fw-light f20 text-dark rating" onclick="rating(this)">
                                    star
                                </span>
                                <span id="3" class="material-symbols-outlined fill-on fw-light f20 text-dark rating" onclick="rating(this)">
                                    star
                                </span>
                                <span id="4" class="material-symbols-outlined fill-on fw-light f20 text-dark rating" onclick="rating(this)">
                                    star
                                </span>
                                <span id="5" class="material-symbols-outlined fill-on fw-light f20 text-dark rating" onclick="rating(this)">
                                    star
                                </span>
                                <input type="hidden" id="ratingValue" value="5">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col"></div>
                        </div>
                    </div>
                </div>

                <!-- 상세리뷰 -->
                <div class="row py-4 border-bottom">
                    <div class="col">
                        <div class="row">
                            <div class="col f09 fw-semibold">
                                상세 리뷰를 작성해 주세요
                            </div>
                        </div>
                        <div class="row pt-3 px-3">
                            <div class="col p-3 d-grid border">
                                <div class="row">
                                    <div class="col"></div>
                                    <textarea oninput="validateInput()" id="reviewTextarea" class="border-0" style="height: 150px;" placeholder="구매하신 상품의 후기를 20자 이상 남겨주시면 다른 고객들에게 큰 도움이 됩니다."></textarea>
                                </div>
                                <div class="row text-end f09 text-body-tertiary">
                                    <div class="col">
                                        <span id="reviewTextCount">0</span>자
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row pt-4 px-3 align-items-center">
                            <div class="col-auto p-0 d-flex align-items-center">
                                <input id="agreeTermsButton" type="checkbox" class="m-0 form-check-input rounded-0 fs-4">
                            </div>
                            <div class="col">
                                <span class="f09">개인정보 수집 및 이용에 대한 동의</span>
                                <span class="f08" style="color: orangered;">(필수)</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 리뷰작성시 참고해주세요 -->
                <div class="row pb-5">
                    <div class="col">
                        <div class="row px-3 py-3 toggle-icon" data-bs-toggle="collapse" data-bs-target="#reviewInfo">
                            <div class="col p-0 f09">
                                리뷰 작성 시 참고해 주세요
                            </div>
                            <div class="col-auto p-0">
                                <span class="material-symbols-outlined fw-light">
                                    keyboard_arrow_down
                                </span>
                            </div>
                        </div>
                        <div class="row ps-3 text-body-tertiary f08 accordion-collapse collapse" id="reviewInfo">
                            <ul class="col ps-3">
                                <li class="p-0 pb-2">
                                    일반 리뷰 500포인트, 사진/동영상 첨부 시 1,000 포인트가 지급되고 혜택은 중복으로 지급되지 않습니다.
                                </li>
                                <li class="p-0 pb-2">
                                    상품금액이 1만원 미만의 상품 구매 후 리뷰 작성 시 사진/동영상 첨부와 관계 없이 100포인트가 지급됩니다. (상품금액 기준 : 쿠폰과 배송비 제외한 옵션 추가금까지 포함된 주문 개수 별 순수 결제 금액)
                                </li>
                                <li class="p-0 pb-2">
                                    동영상 리뷰는 검수 과정을 거쳐 리뷰 운영 정책에 적합할 경우 노출 처리됩니다. 검수는 영업일 기준으로 약 3~5일 이내 소요되고 동영상 노출 시 포인트는 자동 적립 됩니다.
                                </li>
                                <li class="p-0 pb-2">
                                    리뷰 검수 중 운영 정책에 따라 노출 제한 처리될 수 있습니다.
                                </li>
                                <li class="p-0 pb-2">
                                    노출 제한 처리 후 사진 리뷰, 일반 리뷰로 재게시될 수 있으며, 재게시 되는 경우 리뷰유형에 맞는 포인트가 적립됩니다.
                                </li>
                                <li class="p-0">
                                    리뷰 포인트는 최초 등록된 리뷰를 기준으로 적립되며, 작성 후 사진 또는 동영상을 첨부하여도 추가 적립되지 않습니다.
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="row py-4"></div>
            </div>
        </div>
        
    </div>

    <div class="container">
        <button type="button" onclick="writeReview()" class="row px-3 bg-dark text-white fixed-bottom pt-3 pb-4 border-top">
            <div class="col pe-0 text-center">
                리뷰 등록하기
            </div>
        </button>
    </div>

    <script>

        const urlParams = new URL(window.location.href).searchParams;
        const orderProductId = urlParams.get("id");

        let myId = null;

        function setSessionId(){
            const url = "/api/user/getSessionUserId";
            fetch(url)
            .then(response => response.json())
            .then((response) => {
                myId = response.data.userId;
            })
        }

        function formatNumberToPrice(number) {
            return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function validateInput(){
            document.getElementById("reviewTextCount").innerText = document.getElementById("reviewTextarea").value.length;
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('backButton').addEventListener('click', function() {
                history.back();
            });
            setSessionId();
        });

        function rating(star){
            const stars = document.querySelectorAll(".rating");

            stars.forEach(ratingStar=>ratingStar.classList.add("text-opacity-25"))

            for (let i = 1; i <= star.id; i++) {
                document.getElementById(i).classList.remove("text-opacity-25")
            }

            document.getElementById("ratingValue").value=star.id;
        }

        function writeReview(){

            const reviewTextCount = document.getElementById("reviewTextCount").innerText
            const reviewTextarea = document.getElementById("reviewTextarea")

            if(reviewTextCount<20){
                alert("리뷰 내용은 20자 이상 입력해주세요.");
                reviewTextarea.focus();
                return;
            }

            const agreeTermsButton = document.getElementById("agreeTermsButton")
            if(!agreeTermsButton.checked){
                alert("개인정보 수집 및 이용에 동의 후 리뷰 작성이 가능합니다.")
                return;
            }
            
            const rating = document.getElementById("ratingValue").value;
            const content = reviewTextarea.value

            
            const productReview = {
                user_id: myId,
                order_product_id: orderProductId,
                content: content,
                rating: rating
            };

            const url = '/api/store/writeReview'
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(productReview)
            })
            .then(response => response.json())
            .then((response) => {
                console.log('Success');
                alert("리뷰 작성 완료");
                location.href="/store/myReview";
            })
        }

        document.querySelectorAll('.toggle-icon').forEach(button => {
            button.addEventListener('click', function () {
                const icon = this.querySelector('.material-symbols-outlined');
                if (icon.innerText=="keyboard_arrow_up") {
                    icon.innerText="keyboard_arrow_down";
                }else{
                    icon.innerText="keyboard_arrow_up";
                }
            });
        });

    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>