<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet" href="/public/css/font.css">

    <script src="/public/js/lockLikeMobile.js"></script>

    <script src="https://kit.fontawesome.com/7b271bba58.js" crossorigin="anonymous"></script>

    <title>BASECAMP</title>

    <style>
        .fill-on {
            font-variation-settings: 'FILL' 1;
        }
        .fill-off {
            font-variation-settings: 'FILL' 0;
        }
        .seller_profile img{
            aspect-ratio: 1/1;
            width: 60px;
            object-fit: cover;
            object-position: center;
        }
        .icon-col img{
            aspect-ratio: 1/1;
            width: 100%;
            object-fit: cover;
            object-position: center;
        }
        .product-col img{
            aspect-ratio: 1/1;
            width: 100%;
            object-fit: cover;
            object-position: center;
        }
        a{
            text-decoration: none;
            color: black;
        }
        button{
            color: black;
        }
        select {
            color: black;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            padding: 10px;
        }
        .f05{
            font-size: 0.5em;
        }
        .f08{
            font-size: 0.8em;
        }
        .f09{
            font-size: 0.9em;
        }
        .f12{
            font-size: 1.2em;
        }
        .f17{
            font-size: 1.7em;
        }
        .f20{
            font-size: 2em;
        }
        .f40{
            font-size: 4em;
        }
        .active{
            font-weight: bold;
            border-bottom: 2px solid black;
        }
        input {
            padding: 10px;
        }
        input:focus{
            outline: 1px solid black;
        }
        input::placeholder{
            font-size: 0.9em;
            color: rgb(180, 180, 180);
        }
        select:focus{
            outline: 1px solid black;
        }
        .addressInput:focus{
            outline: none;
        }
        
        li::marker {
            font-size: 8px;
        }

    </style>
</head>
<body>

    <!-- top-nav -->
    <div class="container">
        <div class="fixed-top px-4 row border-bottom bg-white py-3 align-items-center">
            <div class="col f12">
                <span>주소 등록/수정</span>
            </div>
            <div class="col-auto pe-0">
                <button id="backButton" class="border-0 bg-transparent d-flex align-items-center">
                    <span class="material-symbols-outlined fw-light">
                        close
                    </span>
                </button>
            </div>
        </div>
    </div>

    <div class="container" style="padding-top: 60.792px;">

        <div class="row px-1 bg-white f09">
            <div class="col">

                <div class="row px-3 pt-4 pb-2">
                    <div class="col p-0">
                        받으시는 분<span class="text-danger"> *</span>
                    </div>
                </div>
                <div class="row px-3">
                    <div class="col p-0 d-grid">
                        <input type="text" id="receiver_name" class="rounded-0 border py-2" placeholder="이름을 입력해주세요.">
                    </div>
                </div>

                <div class="row px-3 pt-4 pb-2">
                    <div class="col p-0">
                        휴대폰 번호<span class="text-danger"> *</span>
                    </div>
                </div>
                <div class="row px-3">
                    <div class="col-4 p-0">
                        <select id="phone-first" class="border col py-2 bg-white rounded-0 w-100">
                            <option value="010">010</option>
                            <option value="011">011</option>
                            <option value="016">016</option>
                            <option value="017">017</option>
                            <option value="018">018</option>
                            <option value="019">019</option>
                            <option value="070">070</option>
                            <option value="0503">0503</option>
                        </select>
                    </div>
                    <div class="col-4 pe-0 d-grid">
                        <input id="phone-second" type="text" class="border py-2 rounded-0 w-100" oninput="validateNumberInput(this)">
                    </div>
                    <div class="col-4 pe-0 d-grid">
                        <input id="phone-third" type="text" class="border py-2 rounded-0 w-100" oninput="validateNumberInput(this)">
                    </div>
                </div>

                <div class="row px-3 pt-4 pb-2">
                    <div class="col p-0">
                        주소<span class="text-danger"> *</span>
                    </div>
                </div>

                <div class="row px-3 align-items-center">
                    <div class="col p-0">
                        <div class="row pb-2 align-items-center">
                            <div class="col pe-0 d-grid">
                                <input type="text" id="postcode" class="addressInput border py-2 bg-body-tertiary rounded-0 w-100" name="postcode" readOnly>
                            </div>
                            <div class="col-auto d-grid">
                                <input type="button" id="postcodeButton" class="form-control fw-semibold border-dark rounded-0 py-2 f09 w-100" onclick="deliveryPostCode()" value="우편번호 검색">
                            </div>
                        </div>
                        <div class="row pb-2">
                            <div class="col d-grid">
                                <input type="text" id="address" name="address" class="addressInput border py-2 bg-body-tertiary rounded-0" readOnly>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col d-grid">
                                <input type="text" id="detailAddress" name="detail_address" class="border py-2 rounded-0" placeholder="상세주소를 입력해주세요.">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row px-3 pt-4 pb-2">
                    <div class="col-auto p-0 d-flex align-items-center">
                        <span class="material-symbols-outlined fw-light text-dark text-opacity-25" id="check_circle">
                            check_circle
                        </span>
                    </div>
                    <div class="col d-flex align-items-center">
                        기본 주소로 설정
                    </div>
                </div>
                <div class="row ps-3 text-body-tertiary fw-semibold f08">
                    <ul class="col ps-3">
                        <li class="pb-1">
                            상품 주문 시 기본 배송지로 선택 됩니다.
                        </li>
                        <li>
                            이벤트 당첨 시 경품이나 안내 등은 기본 주소로 배송됩니다.
                        </li>
                    </ul>
                </div>
                <div class="row py-5"></div>
                <div class="row py-5"></div>

            </div>
        </div>
    
    </div>

    <div class="container">
        <div class="row px-3 bg-white fixed-bottom pt-3 pb-4 border-top">
            <div class="col pe-0 d-grid">
                <a onclick="backButton()" type="button" class="py-2 btn btn-outline-dark rounded-0">
                    취소
                </a>
            </div>
            <div class="col d-grid">
                <a onclick="addressRegister()" type="button" class="py-2 btn btn-dark rounded-0">
                    등록
                </a>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URL(window.location.href).searchParams;
        const prevPage = urlParams.get("prevPage");

        let is_default_address = 0;
        let has_default_address = false;

        let myId = null;

        function backButton(){
            history.back();
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('backButton').addEventListener('click', function() {
                history.back();
            });
            hasDefaultAddress();
        });

        function hasDefaultAddress(){
            fetch("/api/store/hasDefaultAddress")
            .then(response => response.json())
            .then((response) => {
                has_default_address = response.data.hasDefaultAddress;

                if(!has_default_address){
                    const check_circle = document.getElementById("check_circle")
                    check_circle.classList.add("fill-on")
                    check_circle.classList.remove("text-opacity-25")
                    is_default_address = 1;
                }else{
                    check_circle.addEventListener("click", change)
                }
            })
        }
    
        function change(){
            const check_circle = document.getElementById("check_circle")

            if(check_circle.classList.contains("text-opacity-25")){
                check_circle.classList.add("fill-on")
                check_circle.classList.remove("text-opacity-25")
                is_default_address = 1;
            }else{
                check_circle.classList.remove("fill-on")
                check_circle.classList.add("text-opacity-25")
                is_default_address = 0;
            }
        }

        function addressRegister(){
            const receiver_name = document.getElementById("receiver_name");
            
            const phoneFirst = document.getElementById("phone-first");
            const phoneSecond = document.getElementById("phone-second");
            const phoneThird = document.getElementById("phone-third");

            const postcode = document.getElementById("postcode");
            const address = document.getElementById("address");
            const detailAddress = document.getElementById("detailAddress");

            const check_circle = document.getElementById("check_circle");
            
            if(receiver_name.value==""){
                alert("받으시는 분을 입력해주세요.")
                receiver_name.focus();
                return;
            }
            if(phoneSecond.value==""){
                alert("휴대폰번호를 입력해주세요.")
                phoneSecond.focus();
                return;
            }
            if(phoneThird.value==""){
                alert("휴대폰번호를 입력해주세요.")
                phoneThird.focus();
                return;
            }
            if(postcode.value==""){
                alert("주소를 입력해주세요.")
                postcode.focus();
                return;
            }
            if(detailAddress.value==""){
                alert("주소를 입력해주세요.")
                detailAddress.focus();
                return;
            }

            const userDeliveryInfo = {
                receiver_name: receiver_name.value,
                phone: `${phoneFirst.value}-${phoneSecond.value}-${phoneThird.value}`,
                delivery_address: `[${postcode.value}] ${address.value} ${detailAddress.value}`,
                is_default_address: is_default_address
            };

            console.log("Sending data:", userDeliveryInfo);

            const url = '/api/store/addressRegister'
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userDeliveryInfo)
            })
            .then(response => response.json())
            .then((response) => {
                window.location.href = `/store/${prevPage}`;
            })

        }

        function validateNumberInput(input){
            input.value = input.value.replace(/[^0-9]/g, '');
            if (input.value.length > 4) {
                input.value = input.value.slice(0, 4);
            }
        }

        function deliveryPostCode() {
            new daum.Postcode({
                oncomplete: function(data) {
                    var addr = '';
                    var extraAddr = '';

                    if (data.userSelectedType === 'R') {
                        addr = data.roadAddress;
                    } else {
                        addr = data.jibunAddress;
                    }

                    if(data.userSelectedType === 'R'){

                        if(data.bname !== '' && /[동|로|가]$/g.test(data.bname)){
                            extraAddr += data.bname;
                        }
                        if(data.buildingName !== '' && data.apartment === 'Y'){
                            extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                        }
                        if(extraAddr !== ''){
                            extraAddr = ' (' + extraAddr + ')';
                        }
                    }

                    document.getElementById('postcode').value = data.zonecode;
                    document.getElementById("address").value = addr+extraAddr;
                    document.getElementById("detailAddress").focus();
                }
            }).open();
        }
    </script>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>