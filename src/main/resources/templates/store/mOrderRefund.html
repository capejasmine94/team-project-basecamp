<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://kit.fontawesome.com/7b271bba58.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="/public/css/font.css">

    <title>BASECAMP</title>

    <style>
        .fill-on {
            font-variation-settings: 'FILL' 1;
        }
        .fill-off {
            font-variation-settings: 'FILL' 0;
        }
        .seller_profile img{
            aspect-ratio: 1/1;
            width: 100px;
            object-fit: cover;
            object-position: center;
        }
        .icon-col img{
            aspect-ratio: 1/1;
            width: 100%;
            object-fit: cover;
            object-position: center;
        }
        .product-col img{
            aspect-ratio: 1/1;
            width: 100%;
            object-fit: cover;
            object-position: center;
        }
        a{
            text-decoration: none;
            color: black;
        }
        button{
            color: black;
        }
        .f05{
            font-size: 0.5em;
        }
        .f08{
            font-size: 0.8em;
        }
        .f09{
            font-size: 0.9em;
        }
        .f12{
            font-size: 1.2em;
        }
        .f17{
            font-size: 1.7em;
        }
        .f20{
            font-size: 2em;
        }
        .f40{
            font-size: 4em;
        }
        .active{
            font-weight: bold;
            border-bottom: 2px solid black;
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('backButton').addEventListener('click', function() {
                history.back();
            });
        });
    </script>
</head>
<body class="bg-light">

    <!-- top-nav -->
    <!-- <div class="fixed-top px-4 row border-bottom bg-white">
        <div class="col">
            <div class="row py-3 align-items-center">
                <div class="col-auto ps-0">
                    <button id="backButton" class="border-0 bg-transparent d-flex align-items-center">
                        <span class="material-symbols-outlined fw-light">
                            arrow_back_ios
                        </span>
                    </button>
                </div>
                <div class="col ps-0 fw-semibold text-center">
                    환불 요청
                </div>
                <a href="/" class="col-auto pe-0 d-flex align-items-center text-black">
                    <span class="material-symbols-outlined fw-light">
                        home
                    </span>
                </a>
            </div>
        </div>
    </div> -->
    <!-- top-nav -->
    <div class="container-fluid fixed-top">
        <div class="row bg-white py-3 align-items-center">
            <a class="col-auto d-flex align-items-center" id="backButton">
                <span class="material-symbols-outlined fw-light">
                    arrow_back
                </span>
            </a>
            <div class="col fw-semibold text-center">
                환불요청
            </div>
            <a href="/" class="col-auto d-flex align-items-center text-black">
                <span class="material-symbols-outlined fw-light">
                    home
                </span>
            </a>
        </div>
    </div>

    <div class="container" style="padding-top: 56px;">

        <div class="row">
            <div class="col">

                <div class="row px-3 my-2 bg-white">
                    <div class="col p-0">
        
                        <div class="row py-3">
                            <div class="col fw-bold">
                                <span>환불 상품</span>
                            </div>
                        </div>
                        <div class="row pb-4">
                            <div class="col-auto pe-0 seller_profile">
                                <img class="border" th:src="|/images/${orderProductData.product_main_image}|">
                            </div>
                            <div class="col">
                                <div class="row pb-1">
                                    <div class="col f08">
                                        <span th:text="${orderProductData.store_name}">GamjaStore</span>
                                    </div>
                                </div>
                                <div class="row pb-1">
                                    <div class="col f09 fw-semibold">
                                        <span th:text="${orderProductData.product_name}">진짜 맛있는 납작복숭아</span>
                                    </div>
                                </div>
                                <div class="row pb-1 text-body-secondary f08 align-items-center">
                                    <div class="col-auto" th:if="${orderProductData.valueNameList}!=null">
                                        <span th:each="name, iterStat : ${orderProductData.valueNameList}">
                                            <span th:text="${name}">white</span>
                                            <span th:if="${!iterStat.last}">/</span>
                                        </span>
                                    </div>
                                    <div class="col-auto p-0" th:if="${orderProductData.valueNameList}!=null">|</div>
                                    <div class="col">
                                        <span th:text="${orderProductData.quantity}">5</span>개
                                    </div>
                                </div>
                                <div class="row toggle-icon" data-bs-toggle="collapse">
                                    <div class="col-auto pe-0 text-end fw-semibold">
                                        <span th:text="${#numbers.formatDecimal(orderProductData.order_price, 1, 'COMMA', 0, 'POINT')}">13,500</span>원
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>

                <div class="row bg-white px-3 mb-2">
                    <div class="col p-0">
                        <div class="row py-4">
                            <div class="col fw-bold">
                                환불 사유
                            </div>
                        </div>

                        <div class="row">
                            <div class="col">
                                <div class="row pb-2 f09">
                                    <div class="col text-dark">
                                        구매자 책임 사유
                                    </div>
                                </div>
                                <div class="row pb-3">
                                    <div class="col text-body-tertiary">
                                        <select id="buyerResponsible" class="form-select rounded-1 py-3 f09" onchange="selectRefundReason(this)">
                                            <option value="disabled-select-option" disabled selected>환불 사유를 선택하세요</option>
                                            <option th:each="refundReasonDto : ${refundReasonList}" th:value="${refundReasonDto.id}" th:if="${refundReasonDto.is_buyer_responsible}" th:text="${refundReasonDto.description}">단순변심</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row pb-2 f09">
                                    <div class="col text-dark">
                                        판매자 책임 사유
                                    </div>
                                </div>
                                <div class="row pb-4">
                                    <div class="col text-body-tertiary">
                                        <select id="sellerResponsible" class="form-select rounded-1 py-3 f09" onchange="selectRefundReason(this)">
                                            <option value="disabled-select-option" disabled selected>환불 사유를 선택하세요</option>
                                            <option th:each="refundReasonDto : ${refundReasonList}" th:value="${refundReasonDto.id}" th:if="${!refundReasonDto.is_buyer_responsible}" th:text="${refundReasonDto.description}">단순변심</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- 배송지 정보 -->
                <div class="row bg-white px-3 mb-2">
                    <div class="col p-0">
                        
                        <div class="row px-2 py-4">
                            <div class="col p-0 fw-bold">
                                회수지 정보
                            </div>
                        </div>

                        <div class="row px-2">
                            <div class="col pb-3 px-0 border-bottom">
                                <div class="row">
                                    <div class="col fw-semibold" id="receiver_name"></div>
                                    <!-- <div class="col-auto f08 text-body-secondary">
                                        회수지 변경
                                    </div> -->
                                </div>
                                <div class="row pt-2 text-body-tertiary f09">
                                    <div class="col" id="phone"></div>
                                </div>
                                <div class="row f09 pt-1">
                                    <div class="col" id="return_address"></div>
                                </div>
                                <!-- <div class="row pt-3">
                                    <div class="col d-grid">
                                        <button type="button" class="btn btn-outline-primary rounded-0">
                                            이 주소로 회수 요청
                                        </button>
                                    </div>
                                </div> -->
                            </div>
                        </div>
                        <div class="row py-3 f09">
                            <div class="col">
                                <div class="row">
                                    <div class="col">
                                        택배사
                                    </div>
                                    <div class="col text-end">
                                        CJ대한통운
                                    </div>
                                </div>
                                <div class="row pt-2">
                                    <div class="col">
                                        환불 배송비
                                    </div>
                                    <div class="col text-end">
                                        <span class="fw-semibold">무료반품</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="row bg-white px-3 mb-2">
                    <div class="col p-0">
                        
                        <div class="row py-4">
                            <div class="col fw-bold">
                                환불 금액
                            </div>
                            <div class="col-auto fw-semibold">
                                <span th:text="|${#numbers.formatDecimal((orderProductData.salePrice-orderProductData.discount_amount)*orderProductData.quantity-orderProductData.used_point, 1, 'COMMA', 0, 'POINT')}원|">13,500원</span>
                            </div>
                        </div>
                        <div class="row f09 pb-4">
                            <div class="col">
                                <div class="row pb-2">
                                    <div class="col">
                                        상품 가격
                                    </div>
                                    <div class="col fw-semibold text-end">
                                        <span th:text="|${#numbers.formatDecimal(orderProductData.salePrice*orderProductData.quantity, 1, 'COMMA', 0, 'POINT')}원|">39,900원</span>
                                    </div>
                                </div>
                                <div class="row pb-2" th:if="${orderProductData.discount_amount!=0}">
                                    <div class="col">
                                        상품할인
                                    </div>
                                    <div class="col text-primary text-end">
                                        <span th:text="|-${#numbers.formatDecimal(orderProductData.discount_amount*orderProductData.quantity, 1, 'COMMA', 0, 'POINT')}원|">-4,010원</span>
                                    </div>
                                </div>
                                <div class="row pb-2">
                                    <div class="col">
                                        적립금 사용
                                    </div>
                                    <div class="col-auto text-end">
                                        <span th:text="|-${#numbers.formatDecimal(orderProductData.used_point, 1, 'COMMA', 0, 'POINT')}원|">-500원</span>
                                        (환불 완료 시 자동 환원)
                                    </div>
                                </div>
                                <div class="row pb-2">
                                    <div class="col">
                                        배송비
                                    </div>
                                    <div class="col text-end">
                                        무료배송
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col">
                                        반품 배송비
                                    </div>
                                    <div class="col text-danger text-end">
                                        무료반품
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="row bg-white px-3 mb-3">
                    <div class="col p-0">
                        
                        <div class="row py-3 f09 fw-semibold">
                            <div class="col">
                                주의사항
                            </div>
                        </div>
                        <ul class="row pb-4 text-body-tertiary f08" id="notesOnDeliveryInfo">
                            <li>
                                접수 후 평일 기준 1~3일 내 택배 기사님이 연락 또는 방문을 드립니다.
                            </li>
                            <li>
                                회수 상품 재포장 시, 어떠한 사유에서도 '현금' 은 동봉할 필요가 없습니다.
                            </li>
                            <li>
                                환불 시에는 함께 받은 '사은품' 까지 모두 회수되어야 합니다. (단, 교환 시에는 함께 보내지 않아도 됨)
                            </li>
                            <li>
                                같은 브랜드에서 여러 상품의 회수를 위해 배송비를 '한 번만' 결제한 경우, 반드시 묶음 포장(1박스)해야 합니다.
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="row py-5"></div>

                <div class="row px-2 bg-white pt-3 pb-5 border-top fixed-bottom">
                    <div class="col d-grid">
                        <a onclick="requestRefund()" type="button" class="btn btn-dark rounded-0 f09 py-2"><!-- onclick="requestRefund()" -->
                            환불 요청
                        </a>
                    </div>
                </div>
            </div>
        </div>


    </div>

    <script>
        const urlParams = new URL(window.location.href).searchParams;
        let order_product_id = urlParams.get("id");

        function setReturnAddress(){

            console.log(order_product_id)

            fetch(`/api/store/getOrderProductDataForRefund?id=${order_product_id}`)
            .then(response => response.json())
            .then(response => {
                const orderProductData = response.data.orderProductData
                document.getElementById("receiver_name").innerText = orderProductData.receiver_name;
                document.getElementById("phone").innerText = orderProductData.phone;
                document.getElementById("return_address").innerText = orderProductData.delivery_address;
            })
        }
        
        function selectRefundReason(select){
            if(select.id=='buyerResponsible'){
                document.getElementById("sellerResponsible").value = 'disabled-select-option'
            }else{
                document.getElementById("buyerResponsible").value = 'disabled-select-option'
            }
        }

        function requestRefund(){
            const buyerResponsible = document.getElementById("buyerResponsible").value;
            const sellerResponsible = document.getElementById("sellerResponsible").value;

            let reason_refund_id = 0;

            if(buyerResponsible=='disabled-select-option' && sellerResponsible=='disabled-select-option'){
                alert("환불 사유를 선택해주세요.")
                return;
            }else if(buyerResponsible!='disabled-select-option'){
                reason_refund_id = buyerResponsible;
            }else{
                reason_refund_id = sellerResponsible;
            }

            const receiver_name = document.getElementById("receiver_name");
            const phone = document.getElementById("phone");
            const return_address = document.getElementById("return_address");

            const productRefund = {
                reason_refund_id: reason_refund_id,
                order_product_id: order_product_id,
                receiver_name: receiver_name.innerText,
                phone: phone.innerText,
                return_address: return_address.innerText
            }
            
            console.log("Sending data:", productRefund);

            const url = '/api/store/requestRefund'
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(productRefund)
            })
            .then(response => response.json())
            .then((response) => {
                window.location.href = `/store/refundRequestComplete?id=${response.data.productRefundId}`;
            })

        }

        window.addEventListener("DOMContentLoaded",() => {
            setReturnAddress();
        })
    </script>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>