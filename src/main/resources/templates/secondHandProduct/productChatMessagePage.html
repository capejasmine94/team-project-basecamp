<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>채팅방</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="/public/css/secondHandProductCss/style.css">
    <link rel="stylesheet" href="/public/css/secondHandProductCss/chat.css">
</head>
<body>
<!--상단네비-->
<div class="container g-0 py-2 bg-white border-bottom fixed-top">
    <div class="row mx-2">
        <a href="javascript:history.back()" class="col" style="color: black; font-size: 1.1rem">
            <i class="bi bi-chevron-left"></i>
        </a>
        <div class="col text-center" style="font-size: 1.1rem">
            <span th:text="${productTotalDtoList.userDto.nickname}">판매자 아이디</span>
        </div>
        <div class="col"></div>
    </div>
</div>
<div class="container g-0 bg-white border-bottom fixed-top" style="margin-top: 2.7rem">
    <div class="row mx-2 pt-2 pb-2">
        <div class="col-auto pe-0">
            <img class="chatProductImg-custom" th:src="@{/images/{image}(image=${productTotalDtoList.AllContentsDto.main_image})}">
        </div>
        <div class="col">
            <div class="row-auto">
                <div class="col">
                    <span class="me-2" th:text="${productTotalDtoList.AllContentsDto.status}">판매중</span>
                    <span style="font-weight: 400" th:text="${productTotalDtoList.AllContentsDto.title}">상품이름</span>
                </div>
                <div class="col" style="font-weight: 600">
                    <span th:text="|${#numbers.formatInteger(productTotalDtoList.AllContentsDto.price, 0, 'COMMA')}원|"></span>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 채팅방 -->
<div class="container-fluid g-0" style="margin-top: 8rem; padding-bottom: 5rem">
    <!--채팅 시작 날짜 -->
    <div class="row mx-2">
        <div class="col text-center" style="font-size: 0.8rem">
            <span id="date-span" th:text="${#dates.format(productTotalDtoList.AllContentsDto.created_at, 'yyyy년 M월 d일')}">2024년 7월 15일</span>
        </div>
    </div>
    <!-- 메세지 -->
    <div id="chatMessages">
        <!-- 메시지 추가 -->
    </div>
    <!-- 하단 네비 -->
    <div class="container g-0 fixed-bottom border-top bg-white">
        <div class="row mx-2 py-2">
            <div class="col-auto pe-0 d-flex align-items-center">
                <span class="fs-4" style="opacity: 75%;"><i class="bi bi-image"></i></span>
            </div>
            <div class="col pe-0 d-grid d-flex align-items-center">
                <textarea class="ps-3 custom-input" placeholder="메시지 보내기" id="messageInput" rows="1"></textarea>
            </div>
            <div class="col-auto ps-0 d-flex align-items-center">
                <span class="material-symbols-outlined send-icon" id="sendIcon" style="font-size: 1.7rem">send</span>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const urlParams = new URL(window.location.href).searchParams;
    const productId = urlParams.get("product_id");
    const chatRoomId = urlParams.get("chat_room_id");
    let myId = null;

    document.addEventListener('DOMContentLoaded', function () {
        var backButton =  document.querySelector('a[href="javascript:history.back()"]');

        backButton.addEventListener('click', function (event) {
            const url = `/api/chatPolling/findByNullMessage?chat_room_id=${chatRoomId}&product_id=${productId}`;


            fetch(url)
                .then(response => response.json())
                .then(response => {
                });
        });
    });

    // send 색상 변경후 클릭시 send() 실행
    document.addEventListener('DOMContentLoaded', function () {
        var messageInput = document.getElementById('messageInput');
        var sendIcon = document.getElementById('sendIcon');

        messageInput.addEventListener('input', function () {
            if (this.value.trim() !== '') {
                sendIcon.classList.add('active');
            } else {
                sendIcon.classList.remove('active');
            }
        });

        sendIcon.addEventListener('click', function () {
            if (sendIcon.classList.contains('active')) {
                send();
            }
        });

        setSessionUserId();
        setInterval(fetchChatMessages, 3000); // 1초마다 fetchChatMessages 호출
    });

    function send() {
        var messageInput = document.getElementById('messageInput');
        var sendIcon = document.getElementById('sendIcon');
        var message = messageInput.value.trim();
        if (message === '') {
            return;
        }
        const url = "/api/chatPolling/send";
        const data = {
            chat_room_id: chatRoomId,
            message: message,
            sender_id: myId
        };

        console.log('Sending message:', data); // 요청 데이터 로그

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                return response.json();
            })
            .then(() => {
                messageInput.value = '';
                sendIcon.classList.remove('active');
                fetchChatMessages();
            })
            .catch(error => {
                console.error('Fetch error:', error); // 에러 로그
            });
    }

    function fetchChatMessages() {
        const url = `/api/chatPolling/getMessages?chat_room_id=${chatRoomId}`;
        console.log('Fetching messages from:', url); // 요청 URL 로그

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                return response.json();
            })
            .then((response) => {
                console.log('Messages fetched:', response); // 응답 데이터 로그
                if (response.result === "success" && Array.isArray(response.data.message)) {
                    renderChatMessages(response.data.message);
                } else {
                    console.error("Expected an array but got", response);
                }
            })
            .catch(error => {
                console.error('Fetch error:', error); // 에러 로그
            });
    }

    function renderChatMessages(messages) {
        const chatMessagesContainer = document.getElementById('chatMessages');
        chatMessagesContainer.innerHTML = '';

        let lastFormattedTime = '';

        messages.forEach((message, index) => {
            const messageElement = document.createElement('div');
            const formattedTime = formatTime(message.message_time);

            let showTime = false;

            // 다음 메시지가 없다면 현재 메시지는 마지막 메시지
            if (index === messages.length - 1) {
                showTime = true;
            } else {
                // 다음 메시지가 있다면 다음 메시지의 시간을 확인
                const nextMessage = messages[index + 1];
                const nextFormattedTime = formatTime(nextMessage.message_time);
                if (formattedTime !== nextFormattedTime) {
                    showTime = true;
                }
            }

            if (message.sender_id === myId) {
                messageElement.className = 'row mx-2 mt-3 chat-message sender';
                messageElement.innerHTML = `
                <div class="message-box">
                    <span class="message-content">${message.message}</span>
                    ${showTime ? `<span class="message-time">${formattedTime}</span>` : ''}
                </div>
            `;
            } else {
                messageElement.className = 'row mx-2 mt-3 chat-message';
                messageElement.innerHTML = `
                <div class="col-auto pe-0">
                    <img class="img-profile" src="/public/img/secondHandProductImage/기본이미지.png">
                </div>
                <div class="message-box">
                    ${message.message_image ? `<img class="img-send" src="${message.message_image}">` : ''}
                    <span class="message-content">${message.message}</span>
                    ${showTime ? `<span class="message-time">${formattedTime}</span>` : ''}
                </div>
            `;
            }

            chatMessagesContainer.appendChild(messageElement);
            lastFormattedTime = formattedTime;
        });
    }

    function formatTime(dateString) {
        const date = new Date(dateString);
        let hours = date.getHours();
        const minutes = date.getMinutes();
        const ampm = hours >= 12 ? '오후' : '오전';
        hours = hours % 12;
        hours = hours ? hours : 12; // 0을 12로 변환
        const minutesStr = minutes < 10 ? '0' + minutes : minutes;
        return `${ampm} ${hours}:${minutesStr}`;
    }
    function setSessionUserId() {
        const url = "/api/user/getSessionUserId";
        fetch(url)
            .then(response => response.json())
            .then((response) => {
                myId = response.data.userId;
                fetchChatMessages(); // 사용자 ID를 가져온 후 메시지 초기 로드를 수행
            })
            .catch(error => {
                console.error('Fetch error:', error); // 에러 로그
            });
    }

    window.addEventListener("DOMContentLoaded", () => {
        setSessionUserId();
    });
</script>
</body>
</html>